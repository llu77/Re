"""
Knowledge Base — القاعدة المعرفية للتأهيل البصري
=================================================
RAG بسيط يعمل بدون Vector DB خارجي
يمكن توسيعه لاحقاً مع Pinecone أو ChromaDB
"""

import re
import math
from typing import Optional


# ═══════════════════════════════════════════════════════════════
# قاعدة البيانات المعرفية المدمجة (Embedded Knowledge Base)
# ═══════════════════════════════════════════════════════════════

KNOWLEDGE_BASE = [
    # ─── إرشادات WHO ───
    {
        "id": "who_vi_classification",
        "category": "guidelines",
        "title": "تصنيف WHO لضعف البصر (ICD-11)",
        "text": """
تصنيف منظمة الصحة العالمية (WHO) لضعف البصر حسب ICD-11:
- الفئة 0 (طبيعي): حدة إبصار ≥ 6/18 (0.3 decimal)
- الفئة 1 (ضعف معتدل): 6/18 - 6/60 (0.1-0.3 decimal)
- الفئة 2 (ضعف شديد): 6/60 - 3/60 (0.05-0.1 decimal)
- الفئة 3 (ضعف عميق): 3/60 - 1/60 (0.02-0.05 decimal)
- الفئة 4 (إدراك الضوء): 1/60 - Light Perception
- الفئة 5 (عمى كامل): No Light Perception (NLP)
المجال البصري < 10° يُصنف إعاقة بصرية حتى لو كانت حدة الإبصار جيدة.
""",
        "tags": ["WHO", "ICD-11", "تصنيف", "ضعف البصر", "عمى"]
    },
    # ─── بروتوكول AMD ───
    {
        "id": "amd_rehab_protocol",
        "category": "treatment_plans",
        "title": "بروتوكول تأهيل الضمور البقعي المرتبط بالعمر (AMD)",
        "text": """
بروتوكول التأهيل البصري لمرضى AMD:

المرحلة الأولى — التقييم الأساسي:
- قياس حدة الإبصار المركزية والمحيطية
- فحص Amsler Grid لتحديد Scotoma المركزي
- تقييم حساسية التباين (Pelli-Robson)
- تقييم الوظائف البصرية اليومية (VFQ-25)
- فحص المجال البصري

المرحلة الثانية — الأهداف والتدخلات:
1. تدريب PRL (Preferred Retinal Locus):
   - تدريب المريض على استخدام منطقة شبكية صحية بدلاً من المركز
   - تقنية Steady Eye Strategy
   - مدة التدريب: 4-8 أسابيع، 3 مرات/أسبوع

2. الأجهزة المساعدة:
   - للقراءة القريبة: مكبرات عدسية (4-12x) أو مكبرات إلكترونية
   - للمسافة: منظار أحادي أو ثنائي (2-4x)
   - للكمبيوتر: تكبير الشاشة + High Contrast settings
   - CCTVs/EVES: للقراءة المطولة

3. تحسينات بيئية:
   - زيادة الإضاءة (500-1000 lux)
   - تقليل الوهج (Anti-glare filters)
   - تباين عالٍ في المطبوعات (أسود على أبيض)

المرحلة الثالثة — متابعة وتقييم:
- تقييم بعد 4 أسابيع
- قياس: سرعة القراءة، دقة القراءة، رضا المريض
- تعديل الخطة حسب التقدم
""",
        "tags": ["AMD", "ضمور بقعي", "تأهيل", "PRL", "مكبرات"]
    },
    # ─── السكري واعتلال الشبكية ───
    {
        "id": "diabetic_retinopathy_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية السكري",
        "text": """
تأهيل اعتلال الشبكية السكري (Diabetic Retinopathy Rehabilitation):

التحديات الخاصة:
- تذبذب حدة الإبصار مع مستويات السكر
- Scotomas متعددة وغير منتظمة
- مشاكل رؤية الألوان والتباين
- احتمال تدهور الحالة

بروتوكول التقييم:
- حدة الإبصار (مع وبدون تصحيح)
- فحص شامل للمجال البصري
- حساسية التباين (يتأثر مبكراً)
- ETDRS Visual Acuity للمتابعة الدقيقة

التدخلات:
1. إدارة ظروف القراءة:
   - إضاءة متحكم بها (تجنب الوهج)
   - استخدام Typoscope لتحديد السطر
   - قراءة بفترات قصيرة

2. الأجهزة:
   - مكبرات بيضاء/زرقاء لتحسين التباين
   - OCR software (Text-to-Speech)
   - Screen Magnification Software

3. تدريب التكيف البصري:
   - تمارين التكيف مع التغييرات البصرية
   - تقنيات التنقل مع ضعف البصر

مؤشرات التقدم:
- معدل القراءة بالكلمات/دقيقة
- نتائج VFQ-25
- مستوى الاعتماد الذاتي في الأنشطة اليومية
""",
        "tags": ["سكري", "اعتلال الشبكية", "تأهيل", "التباين"]
    },
    # ─── الجلوكوما ───
    {
        "id": "glaucoma_rehabilitation",
        "category": "treatment_plans",
        "title": "تأهيل الجلوكوما (الزرق)",
        "text": """
التأهيل البصري لمرضى الجلوكوما:

خصائص الحالة:
- فقدان محيطي أولاً في معظم الحالات
- المركز يُحفظ حتى مراحل متأخرة
- تأثير على التنقل والتوجه أكثر من القراءة

أهداف التأهيل:
1. تحسين التنقل والسلامة
2. تعويض الفقد المحيطي
3. تحسين الوضوء في الإضاءة المنخفضة

التدخلات:
1. برامج Orientation & Mobility (O&M):
   - تدريب على استخدام العصا البيضاء
   - التنقل في البيئات المألوفة والجديدة
   - استخدام الحواس الأخرى تعويضياً

2. تقنيات تعزيز المجال البصري:
   - Prism glasses للتنبيه المحيطي (مناقشات حول الفعالية)
   - Scanning Techniques: تدريب تحريك الرأس والعين

3. تعديلات المنزل والبيئة:
   - تحسين الإضاءة خاصةً في الدرج والممرات
   - إزالة عقبات في مسارات المشي
   - تباين لوني للأثاث والدرج

معايير النجاح:
- اختبار Mobility Course قبل وبعد
- VFQ-25 قسم التنقل
- عدد حوادث السقوط
""",
        "tags": ["جلوكوما", "زرق", "تنقل", "O&M", "محيطي"]
    },
    # ─── أجهزة مساعدة بصرية ───
    {
        "id": "optical_devices_guide",
        "category": "devices",
        "title": "دليل الأجهزة البصرية المساعدة",
        "text": """
أنواع الأجهزة البصرية المساعدة:

أولاً — أجهزة القراءة القريبة:
1. العدسات المكبرة اليدوية (Hand Magnifiers):
   - مناسبة للاستخدام المؤقت وقراءة العلامات
   - نطاق: 2x-10x
   - ميزة: رخيصة، سهلة الاستخدام
   - عيب: تحتاج يداً حرة، مسافة عمل قصيرة

2. العدسات المكبرة المستقلة (Stand Magnifiers):
   - للقراءة المطولة على السطح
   - نطاق: 2x-15x
   - ميزة: مسافة عمل ثابتة، لا تحتاج تثبيت
   - مناسبة لكبار السن ومرضى رعاش اليد

3. النظارات التلسكوبية (Spectacle Telescopes):
   - للمسافات البعيدة (TV، اللوح، الأفراد)
   - نطاق: 2.2x-4x
   - ميزة: تحرر اليدين
   - عيب: مجال رؤية ضيق

4. المكبرات الإلكترونية (CCTV/EVES):
   - للقراءة والكتابة والمهام الدقيقة
   - التكبير: 2x-70x
   - مزايا: تحكم في التباين والألوان، يمكن عكس الألوان
   - أنواع: طاولي، محمول (مثل Optelec Compact)

ثانياً — تقنيات مساعدة رقمية:
1. Screen Magnification Software:
   - ZoomText, Windows Magnifier, macOS Zoom
   - تكبير 2x-36x مع تتبع الماوس

2. Screen Readers:
   - NVDA (مجاني)، JAWS، VoiceOver
   - مناسبة لضعف البصر الشديد والعمى

3. OCR & Text-to-Speech:
   - OrCam MyEye: جهاز مثبت على النظارة
   - Seeing AI (Microsoft): تطبيق مجاني

اعتبارات الاختيار:
- نوع وشدة ضعف البصر
- طبيعة المهام اليومية المطلوبة
- المهارة في استخدام التقنية
- التكلفة والتأمين الصحي
- قدرة حمل الجهاز واستخدامه
""",
        "tags": ["أجهزة مساعدة", "مكبرات", "CCTV", "تقنية"]
    },
    # ─── بروتوكول التقييم الوظيفي ───
    {
        "id": "functional_assessment_protocol",
        "category": "assessments",
        "title": "بروتوكول التقييم الوظيفي البصري",
        "text": """
بروتوكول التقييم الوظيفي البصري الشامل:

المرحلة 1 — المقابلة وجمع التاريخ:
- التشخيص الطبي وتاريخ المرض
- الشكاوى الوظيفية الرئيسية
- الأهداف والاحتياجات اليومية
- التاريخ الدوائي (خاصةً مؤثرات العيون)
- الحالات الصحية المصاحبة
- الوضع الأسري والمهني والاجتماعي

المرحلة 2 — الفحص البصري:
أ) حدة الإبصار:
   - ETDRS Chart (أفضل دقة)
   - Bailey-Lovie LogMAR Chart
   - Snellen Chart (أقل دقة لكن شائع)
   - قياس للعين اليمنى، اليسرى، ثم كلتيهما

ب) المجال البصري:
   - Confrontation Fields (سريع للشاشة)
   - Amsler Grid (المركز 10°)
   - Humphrey Automated Perimetry (إن توفر)

ج) حساسية التباين:
   - Pelli-Robson Chart
   - Mars Letter Contrast Sensitivity Test

د) رؤية الألوان (عند الحاجة):
   - Farnsworth-Munsell 100-Hue Test

المرحلة 3 — تقييم الوظائف الحياتية:
- MNREAD Acuity Chart: سرعة ودقة القراءة
- Pepper VSRT: مهارات القراءة الوظيفية
- VFQ-25 استبيان: جودة الحياة البصرية
- Melbourne Low Vision ADL Index

المرحلة 4 — تجربة الأجهزة:
- تجربة مكبرات متنوعة
- تحديد القوة المثلى
- تدريب استخدامي مبدئي

التوثيق:
- استخدام نماذج SOAP أو ICF
- صور/مخططات عند الحاجة
- جلسة متابعة بعد 4-6 أسابيع
""",
        "tags": ["تقييم", "MNREAD", "VFQ-25", "بروتوكول", "وظيفي"]
    },
    # ─── تمارين بصرية ───
    {
        "id": "visual_exercises",
        "category": "exercises",
        "title": "تمارين التأهيل البصري والإدراك",
        "text": """
تمارين التأهيل البصري:

1. تمارين تدريب PRL (Preferred Retinal Locus):
   الهدف: تدريب المريض على استخدام المنطقة الشبكية الصحية
   التقنية:
   - استخدام برامج الحاسب (Macular Degeneration App)
   - تمارين تتبع النقاط على شاشة محكومة
   - تمارين Monocular Steady Eye Strategy
   التكرار: 20 دقيقة يومياً، 3 مرات/أسبوع

2. تمارين تعزيز المجال البصري المحيطي:
   الهدف: تحسين الوعي المحيطي لمرضى Scotoma المركزي
   التمرين:
   - تحريك الرأس والعين بشكل منهجي (Scanning)
   - تتبع أشياء متحركة في المجال المحيطي
   - تمارين التنبه للحركة من الأطراف

3. تدريب إدراك التباين:
   الهدف: تحسين قدرة التمييز في الإضاءة المنخفضة
   التمرين:
   - قراءة نصوص بتباينات متدرجة
   - تمييز الأشياء في ظروف إضاءة متغيرة
   - تمارين تمييز الوجوه والتعبيرات

4. تمارين تنسيق اليد-العين:
   الهدف: تحسين المهارات الدقيقة مع ضعف البصر
   التمرين:
   - خياطة ورسم مع مكبر
   - استخدام أدوات الإنجاز اليومي بشكل آمن
   - تمارين Peg Board

5. تمارين التحمل البصري:
   الهدف: زيادة مدة القراءة دون إجهاد
   البروتوكول:
   - البدء بـ 5 دقائق قراءة مريحة
   - زيادة 2 دقيقة كل أسبوع
   - استراحات منتظمة (20-20-20: كل 20 دقيقة، انظر 20 قدماً لمدة 20 ثانية)
""",
        "tags": ["تمارين", "PRL", "تأهيل", "تدريب", "إدراك بصري"]
    },

    # ─── تأهيل الأطفال — CVI ───
    {
        "id": "cvi_pediatric_rehab",
        "category": "treatment_plans",
        "title": "تأهيل الإعاقة البصرية القشرية لدى الأطفال (CVI)",
        "text": """
الإعاقة البصرية القشرية (Cortical Visual Impairment - CVI):

التعريف والخصائص:
- أكثر أسباب ضعف البصر شيوعاً في الأطفال في الدول المتطورة
- الضرر في المسارات البصرية القشرية لا في العين ذاتها
- السمات: قد تكون حدة الإبصار الأمامية طبيعية مع ضعف معالجة بصرية

علامات CVI عند الأطفال:
- التحديق في الأضواء (Light Gazing)
- تفضيل الألوان الزاهية (خاصةً الأحمر والأصفر)
- صعوبة في الوجوه والمشاهد المعقدة (Visual Complexity)
- تحسن الرؤية في بيئات هادئة وبسيطة (Field Preference)
- Latency بصرية (تأخر الاستجابة البصرية)
- استخدام الرؤية المحيطية أحياناً

مراحل CVI (Roman Scale):
- المرحلة I (1-3): اهتمام بصري محدود، ضوء ولون فقط
- المرحلة II (4-6): تحسن الاهتمام، تمييز أشياء مألوفة
- المرحلة III (7-10): رؤية وظيفية جيدة، صعوبات في التعقيد

بروتوكول التدخل:
1. تبسيط البيئة البصرية (Visual Complexity Reduction)
2. استخدام ألوان زاهية ومألوفة
3. تقليل المثيرات المشتتة
4. زيادة حجم الأشياء تدريجياً
5. التدريب مع ضوء خلفي للأجهزة اللوحية
6. برامج Computer-based visual stimulation

الأهداف التعليمية:
- التنسيق مع المدرسة لتكييف البيئة الصفية
- تدريب المعلم على احتياجات CVI
- استخدام الـ iPad مع تطبيقات CVI المخصصة
""",
        "tags": ["CVI", "أطفال", "قشري", "تأهيل", "بصري", "تدخل مبكر"]
    },

    # ─── ضعف البصر عند الخدج (LMA) ───
    {
        "id": "lma_premature_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية عند الخدج (ROP/LMA)",
        "text": """
اعتلال شبكية الخدج (Retinopathy of Prematurity - ROP):

التصنيف والمراحل:
- المرحلة 1: خط ترسيم رفيع
- المرحلة 2: حافة أو نتوء
- المرحلة 3: نسيج ليفي وعائي خارج الشبكية
- المرحلة 4: انفصال جزئي للشبكية (4A: دون مركز، 4B: مع مركز)
- المرحلة 5: انفصال كامل للشبكية

Plus Disease: وعائية متضخمة متلوية = مؤشر للعلاج

التدخل العلاجي:
- Zone I/II + Stage 3 + Plus: علاج بالليزر أو Avastin
- Zone II/III Stage 1-2: مراقبة
- Stage 4-5: جراحة (Vitrectomy/Scleral Buckle)

التأثيرات المصاحبة لـ ROP المتأخر:
- ندبة بقعية
- حول (Strabismus)
- ضعف بصر شديد
- ضعف في المجال المحيطي
- قِصَر النظر المفرط (High Myopia)

بروتوكول التأهيل:
1. تقييم شامل ≥ 6 أشهر
2. النظارات لمعالجة الانكسار المرتبط
3. أجهزة مساعدة مناسبة للعمر:
   - 0-3 سنوات: ألعاب بصرية عالية التباين
   - 3-6 سنوات: تمارين إدراك بصري
   - 6+: أجهزة CCTV للمدرسة
4. تدخل مبكر متعدد التخصصات مع:
   - طب الأطفال
   - العلاج الوظيفي
   - التربية الخاصة
""",
        "tags": ["ROP", "خدج", "شبكية", "أطفال", "ولادة مبكرة", "LMA"]
    },

    # ─── التأهيل العصبي البصري ───
    {
        "id": "neuro_visual_rehab",
        "category": "treatment_plans",
        "title": "التأهيل العصبي البصري (Neuro-Visual Rehabilitation)",
        "text": """
التأهيل العصبي البصري:

الحالات الشائعة:
- السكتة الدماغية (Stroke) مع Hemianopia
- إصابات الرأس (TBI) مع اضطرابات بصرية
- التصلب اللويحي المتعدد (MS) مع التهاب عصب بصري
- الأورام الدماغية بعد العلاج
- ضعف البصر العصبي (Optic Neuropathy)

المشاكل البصرية العصبية الشائعة:
1. فقدان نصف المجال البصري (Hemianopia):
   - Homonymous: فقدان نفس النصف في كلتا العينين
   - Bitemporal: نادر، من ورم نخامي

2. اضطرابات حركة العين:
   - شلل العصب الثالث: تدلي الجفن + توسع الحدقة
   - شلل العصب السادس: حول أفقي + رؤية مزدوجة
   - Nystagmus: تأرجح غير إرادي

3. صعوبات الإدراك البصري:
   - Alexia (عمى الكلمات)
   - Visual agnosia (عدم التعرف البصري)
   - Neglect (إهمال نصف الفضاء)

بروتوكولات التدخل:
1. للـ Hemianopia:
   - تدريب Scanning منهجي للجانب المفقود
   - Prism glasses للتوسيع المؤقت
   - تمارين Saccadic Eye Movements

2. للـ Diplopia (رؤية مزدوجة):
   - تغطية عين مؤقتاً (Patching)
   - Prism للعلاج
   - علاج السبب الجذري

3. للـ Nystagmus:
   - إيجاد Null Point (أفضل موضع للرأس)
   - عدسات للتقليل من الحركة
   - Prism في بعض الحالات

معايير التحسن:
- توسع المجال البصري الفعّال
- تقليل حوادث التصادم والسقوط
- تحسين سرعة القراءة واستيعاب النص
- نتائج VFQ-25 قسم الوظيفة البصرية
""",
        "tags": ["عصبي", "سكتة دماغية", "TBI", "hemianopia", "نيورولوجي", "بصري"]
    },

    # ─── التوجه والتنقل ───
    {
        "id": "orientation_mobility_protocol",
        "category": "protocols",
        "title": "بروتوكول التوجه والتنقل (O&M Protocol)",
        "text": """
التوجه والتنقل (Orientation & Mobility - O&M):

التعريف:
- التوجه: معرفة موضعك في البيئة
- التنقل: القدرة على التحرك بأمان وفعالية

المهارات الأساسية:
1. التوجه الحسي:
   - استخدام السمع للتعرف على البيئة
   - استخدام اللمس والحركة
   - الخرائط الذهنية للبيئات المألوفة

2. تقنيات العصا البيضاء:
   - Touch Technique (اللمس المتناوب)
   - Constant Contact Technique
   - Diagonal Technique (في الداخل)
   - Two-Point Touch Technique

3. تقنيات الإرشاد البشري:
   - Modified Sighted Guide Technique
   - الدخول للأماكن الضيقة
   - الدرج والأسطح المتغيرة

4. مهارات التنقل في الخارج:
   - تقاطعات الطرق البسيطة والمعقدة
   - استخدام وسائل النقل العام
   - التنقل في الأماكن غير المألوفة

مراحل البرنامج التدريبي:
- المرحلة 1 (2-4 أسابيع): داخل المنزل والمبنى
- المرحلة 2 (4-6 أسابيع): حي سكني مألوف
- المرحلة 3 (6-8 أسابيع): تقاطعات وأماكن عامة
- المرحلة 4 (8-12 أسبوع): مواصلات عامة وبيئات جديدة

التقنيات الحديثة المساعدة:
- تطبيقات الملاحة الصوتية (Google Maps وضع الرؤية المنخفضة)
- OrCam للقراءة اللحظية
- Sonar Electronic Travel Aids
- GPS متخصص لضعاف البصر

الكلاب المرشدة:
- معيار: ضعف بصر شديد + لياقة جسدية
- التدريب: 3-4 أسابيع
- متابعة مدى الحياة

معايير التقييم:
- Hill Performance Test of Selected Positional Concepts
- Blindness Learning Reading Test (BLRT)
- Independent Living Scale
""",
        "tags": ["O&M", "توجه", "تنقل", "عصا بيضاء", "استقلالية", "كلاب مرشدة"]
    },

    # ─── القراءة العربية وضعف البصر ───
    {
        "id": "arabic_reading_low_vision",
        "category": "protocols",
        "title": "بروتوكول القراءة العربية لضعف البصر",
        "text": """
بروتوكول القراءة العربية لمرضى ضعف البصر:

خصائص الخط العربي التي تؤثر على القراءة بضعف البصر:
1. الكتابة من اليمين إلى اليسار (RTL)
2. التشكيل (Diacritical Marks): يزيد الصعوبة 25-30%
3. الحروف المتصلة: تتطلب دقة أعلى من الحروف المنفصلة
4. نقاط الحروف: (ب/ت/ث/ج/ح) تتشابه بضعف التباين

حسابات حجم الطباعة:
- نص عادي: تكبير × 2 من الحد الأدنى للقراءة
- نص مشكّل: تكبير × 1.3 إضافي
- القرآن الكريم: حد أدنى 18pt مع تشكيل كامل
- كتب الأطفال: 18-24pt

معيار MNREAD-A للعربية:
- قراءة وظيفية: ≥ 60 كلمة/دقيقة
- قراءة سليمة: ≥ 120 كلمة/دقيقة
- العتبة للمكبر: حين يقل عن 60 كلمة/دقيقة بدون مساعدة

بروتوكول تدريب القراءة العربية:
المرحلة 1 — تقييم الخط الأساسي:
  - MNREAD-A: سرعة القراءة وحدة حدة الإبصار ومسافة القراءة
  - نصوص بدون وبمع تشكيل
  - اختبار القراءة القرآنية خصيصاً إذا كانت هدف المريض

المرحلة 2 — اختيار الجهاز المناسب:
  - مكبر يدوي للاستخدام القصير
  - CCTV للقراءة المطولة
  - iPad/Tablet للنص الرقمي مع تطبيقات القرآن

المرحلة 3 — التدريب:
  - تمارين RTL Scanning مع المكبر
  - تقنية Typoscope بالعربية
  - استراحة 5-10 دقيقة كل 20 دقيقة قراءة

خاصية الأنظمة الإلكترونية للعربية:
- الخطوط المناسبة: Simplified Arabic, Traditional Arabic
- تجنب: أمبري أو الخطوط الزخرفية بضعف البصر
- الحد الأدنى للحجم الرقمي: 18-20pt
""",
        "tags": ["عربي", "قراءة", "MNREAD-A", "تشكيل", "قرآن", "RTL", "خط"]
    },

    # ─── التكيف النفسي مع فقدان البصر ───
    {
        "id": "psychological_adjustment_vision_loss",
        "category": "protocols",
        "title": "بروتوكول التكيف النفسي مع فقدان البصر",
        "text": """
التكيف النفسي مع فقدان البصر:

الأثر النفسي لفقدان البصر:
- خطر الاكتئاب: 3-5 أضعاف مقارنة بالسكان العاديين
- خطر القلق: 2-3 أضعاف
- العزلة الاجتماعية شائعة خاصةً لكبار السن
- فقدان الهوية المهنية والاجتماعية

مراحل التكيف (كوبلر-روس المعدّلة لفقدان البصر):
1. الإنكار: رفض قبول التشخيص، البحث عن آراء ثانية
2. الغضب: نحو العائلة أو الطبيب أو القدر
3. المساومة: البحث عن علاجات بديلة، الأمل الزائد
4. الاكتئاب: حزن عميق، انسحاب، فقدان الاهتمام
5. القبول: التكيف الإيجابي، إيجاد معنى جديد

أدوات الفحص المعتمدة:
- PHQ-2: فحص أولي سريع (سؤالان)
- PHQ-9: تقييم الاكتئاب الكامل (9 أسئلة)
- GDS-15: مقياس الاكتئاب للمسنين (15 سؤالاً)
- VFQ-25 القسم النفسي: جودة الحياة البصرية

التدخلات النفسية الفعّالة:
1. العلاج السلوكي المعرفي المعدّل لضعف البصر (CBT-VI):
   - تعديل الأفكار السلبية عن فقدان البصر
   - التعرض التدريجي للمواقف المتجنَّبة
   - تنشيط السلوك الإيجابي

2. العلاج بالقبول والالتزام (ACT):
   - قبول الواقع البصري
   - التركيز على القيم والأهداف بديلاً عن الفقد
   - Mindfulness للتعامل مع الإجهاد

3. مجموعات الدعم:
   - دعم الأقران من مرضى ضعف البصر
   - مشاركة التجارب والحلول العملية
   - تقليل الشعور بالوحدة

4. الدعم الأسري:
   - تثقيف العائلة عن الاحتياجات والقدرات
   - تحقيق التوازن بين المساعدة والاستقلالية
   - تجنب الحماية الزائدة

مؤشرات الإحالة للطب النفسي:
- PHQ-9 ≥ 15
- أفكار انتحارية (Q9 أي درجة > 0)
- اكتئاب لا يستجيب لـ 4 أسابيع دعم
- قصور وظيفي شديد
""",
        "tags": ["نفسي", "اكتئاب", "PHQ-9", "تكيف", "فقدان البصر", "CBT", "دعم"]
    },

    # ─── اعتلال الشبكية الصباغي ───
    {
        "id": "retinitis_pigmentosa_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية الصباغي (RP)",
        "text": """
بروتوكول تأهيل اعتلال الشبكية الصباغي (Retinitis Pigmentosa - RP):

الخصائص المميزة:
- فقدان الرؤية الليلية أولاً (Night Blindness)
- تضيق تدريجي في المجال البصري
- قد تبقى حدة الإبصار المركزية طويلاً
- وراثي: أكثر أنواع ضعف البصر الوراثية شيوعاً

التسلسل الطبيعي:
- مرحلة مبكرة: عمى ليلي + ضعف مجال محيطي
- مرحلة متوسطة: Tunnel Vision (رؤية نفقية)
- مرحلة متأخرة: فقدان المركز + عمى وظيفي

التقييم الخاص بـ RP:
- Goldmann Perimetry: لرسم المجال البصري المتبقي
- ERG (Electroretinogram): لقياس وظيفة الشبكية
- Dark Adaptation Testing: لقياس التكيف الليلي
- OCT: لمتابعة السُّمك البقعي

التدخلات:
1. للرؤية الليلية:
   - نظارات Night Driving بعدسة منقرة الوهج
   - أجهزة التصوير الحراري (NVG) في الحالات الشديدة
   - تحسين الإضاءة الداخلية بشكل ملحوظ

2. لفقدان المجال المحيطي:
   - عدسات Prism للتوسيع البصري
   - تدريب O&M مبكر (قبل التدهور الشديد)
   - تقنيات Scanning المنهجي

3. للمرحلة المتقدمة:
   - التخطيط المسبق: "Planning for Blindness"
   - تعلم البرايل أو النصوص الصوتية بشكل استباقي
   - إدارة قانونية ومالية مبكرة

الدعم النفسي الخاص بـ RP:
- التعامل مع التدهور التدريجي المتوقع
- خطط مستقبلية واقعية دون يأس
- مجموعات دعم عائلات RP

التطورات العلاجية:
- حقن مضادات الأكسدة (Vitamin A Palmitate - جدل علمي)
- Gene Therapy: موجودة لبعض الجينات (RPE65)
- Retinal Prosthesis (Argus II): للمرحلة النهائية
""",
        "tags": ["RP", "شبكية صباغي", "عمى ليلي", "مجال بصري", "وراثي", "تأهيل"]
    },

    # ─── ساد (إعتام عدسة العين) ───
    {
        "id": "cataract_pre_post_op",
        "category": "protocols",
        "title": "بروتوكول ما قبل وبعد جراحة الساد (إعتام عدسة العين)",
        "text": """
بروتوكول الساد — قبل وبعد الجراحة:

قبل الجراحة:
1. التقييم الوظيفي:
   - هل يؤثر الساد فعلاً على الوظائف اليومية؟
   - مقارنة حدة الإبصار مع وبدون تصحيح
   - Visual Glare Testing (Brightness Acuity Tester)

2. تعديلات مؤقتة:
   - زيادة الإضاءة في بيئة المريض
   - نظارات تصفية الوهج (Anti-glare tints)
   - نظارات قراءة بحجم مناسب للمرحلة الحالية

بعد الجراحة — المرحلة المبكرة (0-4 أسابيع):
- تعليمات قطرات العين وجدولها
- تجنب: الضغط على العين، الإجهاد، الماء
- استئناف القراءة: عادةً بعد 3-7 أيام
- قياس الانكسار الجديد: بعد 4-6 أسابيع

بعد الجراحة — التأهيل:
1. تعديل العدسات الجديدة (IOL):
   - Monofocal: نظارات للقراءة ضرورية
   - Multifocal: تكيف بصري قد يستغرق 3-6 أشهر
   - Toric: لتصحيح الاستجماتيزم

2. حالات Residual Low Vision:
   - إذا كان الساد يُصاحب ضمور بقعي أو تلف شبكية
   - التقييم البصري الوظيفي الكامل بعد 6-8 أسابيع
   - بدء برنامج التأهيل البصري الكامل

3. ما بعد الساد الثانوي (PCO):
   - Nd:YAG Laser Capsulotomy
   - التأهيل البصري بعد التدخل

مؤشرات عدم التحسن بعد الجراحة:
- وجود ضمور بقعي (AMD)
- اعتلال الشبكية السكري
- غيوم القرنية (Corneal Opacity)
- أمراض العصب البصري
→ في هذه الحالات: إحالة لبرنامج تأهيل بصري متخصص
""",
        "tags": ["ساد", "إعتام عدسة", "جراحة", "ما بعد عملية", "IOL", "تأهيل"]
    },

    # ─── الأطفال ذوو الإعاقة البصرية والمدرسة ───
    {
        "id": "school_visual_impairment_protocol",
        "category": "protocols",
        "title": "بروتوكول الطالب ذو الإعاقة البصرية في المدرسة",
        "text": """
بروتوكول الطالب ذو الإعاقة البصرية في المدرسة:

التشريع والحقوق:
- الطلاب ذوو الإعاقة البصرية لهم حق في التعليم المتكافئ
- وثيقة IEP (Individual Education Program) إلزامية
- تعديلات المنهج والبيئة من حقوق المريض

التقييم التعليمي:
1. Functional Vision Assessment (FVA) في بيئة المدرسة
2. Learning Media Assessment: هل البرايل أم المطبوع مناسب؟
3. تقييم مدى الأثر على المواد الدراسية المختلفة

تعديلات الفصل الدراسي:
البيئة الجسدية:
- الجلوس في الصف الأول (مسافة ≤ 2م من السبورة)
- إضاءة كافية وبلا ظلال على المقاعد
- السبورة بيضاء (Whiteboard) بمؤشر عريض ومتباين

المواد التعليمية:
- تكبير المواد المطبوعة (ملحوظة: تكبير ≥ 24pt)
- نسخ رقمية للكتب للتكبير في الكمبيوتر
- الوقت الإضافي للاختبارات (50-100%)

التقنيات المساعدة في المدرسة:
- مكبر CCTV للمطبوعات
- كمبيوتر مع برامج تكبير (ZoomText/Windows Magnifier)
- Screen Reader لضعف البصر الشديد
- الآلة الحاسبة الناطقة

مهارات الحياة المستقلة (ILS):
- التنقل في المدرسة بأمان
- استخدام المرافق والكافيتيريا
- تدريب على المهارات الاجتماعية

دور الأخصائي في المدرسة:
- التواصل مع المعلمين والإدارة
- تدريب الكادر التعليمي
- تدريب الطالب على أجهزته
- تقرير منتصف الفصل ونهايته

الانتقال من المدرسة للجامعة:
- التخطيط المبكر من سنوات دراسية مبكرة
- التواصل مع مراكز ذوي الاحتياجات الخاصة في الجامعة
- مهارات المناصرة الذاتية (Self-Advocacy)
""",
        "tags": ["مدرسة", "تعليم", "IEP", "طالب", "أطفال", "بصري", "تكيف"]
    },

    # ─── الشيخوخة وضعف البصر ───
    {
        "id": "elderly_low_vision_rehab",
        "category": "treatment_plans",
        "title": "تأهيل ضعف البصر لكبار السن",
        "text": """
خصائص ضعف البصر لدى كبار السن:

التغيرات البصرية الطبيعية مع التقدم في العمر:
- Presbyopia: فقدان التركيز القريب (طبيعي من 40+)
- تقليل التكيف في الإضاءة المنخفضة
- زيادة الحساسية للوهج
- تراجع حساسية التباين

الأسباب الأكثر شيوعاً لضعف البصر في كبار السن:
- الضمور البقعي المرتبط بالعمر (AMD): الأكثر شيوعاً
- الساد (Cataract): قابل للعلاج جراحياً
- الجلوكوما (Glaucoma): ثاني أكثر مسبب للعمى
- الاعتلال السكري (Diabetic Retinopathy)

خصوصيات تأهيل كبار السن:
1. التكيف الأبطأ مع الأجهزة الجديدة (2-4 أضعاف وقت الشباب)
2. اشتراط سهولة الاستخدام (User-Friendly Devices)
3. التأثير على الكرامة الشخصية والاستقلالية أهم من الأداء التقني
4. الأمراض المصاحبة تؤثر: السرطان، رعاش اليد، الخرف

مخاطر خاصة:
- السقوط: ضعف البصر يزيد خطر السقوط 2-4 أضعاف
  → تقييم Safety الشامل في المنزل
- العزلة الاجتماعية: قد يتوقف عن الخروج
  → ربط بخدمات المجتمع والمواصلات
- الاكتئاب: GDS-15 مناسب للتقييم

الأجهزة الأكثر نجاحاً مع كبار السن:
- مكبر يدوي بضوء LED (سهل + مألوف)
- هاتف ذكي بالتكبير (أي Accessibility Settings)
- CCTV للقراءة المطولة
- مكبر مستقل بأضواء (Stand Magnifier مضاء)

اعتبارات خاصة بالسعودية:
- التجمع الأسري يوفر دعماً طبيعياً
- القرآن الكريم هدف قراءة رئيسي لكبار السن
- الأنشطة الدينية (الصلاة، الحج) أولوية وظيفية
""",
        "tags": ["كبار السن", "شيخوخة", "AMD", "سقوط", "استقلالية", "تأهيل"]
    },
    # ═══════════════════════════════════════════════════════════════
    # تقنيات التأهيل البصري المتقدمة (Technical Appendix)
    # ═══════════════════════════════════════════════════════════════
    # ─── تدريب الرؤية اللامركزية (EVT) ───
    {
        "id": "evt_biofeedback_protocol",
        "category": "protocols",
        "title": "تدريب الرؤية اللامركزية (EVT) مع Microperimetry Biofeedback",
        "text": """
تدريب الرؤية اللامركزية (Eccentric Viewing Training - EVT):
تقنية تعويضية أساسية للفقد البصري المركزي (central scotoma) كما في AMD وStargardt.

الأنواع:
1. EVT التقليدي: تحديد PRL يدوياً → تمارين تثبيت → قراءة لامركزية
2. MBFT (Microperimetry Biofeedback Training): تدريب مع MAIA أو MP-3
   - يحدد أفضل PRL بناءً على خريطة الحساسية الفعلية
   - تغذية راجعة صوتية فورية أثناء التثبيت
   - Vingolo 2018 RCT: تحسن BCEA بنسبة 50-70% (أفضل من التقليدي)

البروتوكول:
- المرحلة 1: فحص microperimetry → تحديد PRL الأمثل
- المرحلة 2: 8-12 جلسة biofeedback (15-20 دقيقة/جلسة)
- المرحلة 3: جلسات تعزيز شهرية لمدة 6 أشهر

المعايير:
- حدة الإبصار: 0.02-0.3 decimal
- شرط: بقاء رؤية محيطية + قدرات إدراكية كافية
- موانع: عمى كامل، رأرأة شديدة، ضعف إدراكي حاد

النتائج المتوقعة:
- تحسن سرعة القراءة 40-80%
- تحسن استقرار التثبيت (BCEA) 50-70%
- تحسن VFQ-25 بمعدل 8-15 نقطة

مستوى الدليل: 1b (RCT) — التوصية: A
المراجع: Vingolo 2018, Morales 2020, Tarita-Nistor 2019
""",
        "tags": ["EVT", "PRL", "eccentric viewing", "biofeedback", "microperimetry", "MAIA",
                 "MP-3", "central scotoma", "AMD", "Stargardt", "MBFT", "تثبيت"]
    },
    # ─── تدريب المسح البصري ───
    {
        "id": "scanning_training_protocol",
        "category": "protocols",
        "title": "تدريب المسح البصري للعمى الشقي (Scanning Training)",
        "text": """
تدريب المسح البصري (Compensatory Scanning Training):
تقنية تعويضية أساسية للعمى الشقي (hemianopia) بعد السكتة الدماغية أو TBI.

الطرق:
1. طريقة Zihl (العيادية): تدريب منظم على المسح نحو الجانب المصاب
   - Pollock 2019 Cochrane: أقوى دليل (1a) لفعالية scanning في hemianopia
   - 20-30 جلسة، 40-60 دقيقة، 3-5×/أسبوع

2. NeuroEyeCoach (NEC) — منزلي محوسب:
   - Aimola 2014 RCT: نتائج مكافئة للعلاج العيادي
   - 20-30 دقيقة يومياً لمدة 8-12 أسبوع
   - تكيف تلقائي للصعوبة + لوحة متابعة إلكترونية
   - أعلى التزام (بيئة منزلية)

3. SEARCH Trial (متعدد المراكز):
   - دراسة كبيرة لتدريب scanning بعد السكتة
   - نتائج إيجابية في سرعة البحث والقراءة

المراحل:
1. التوعية: فهم العمى الشقي وآلية التعويض
2. مسح ثابت: أهداف ثابتة → حركات عين منظمة
3. مسح ديناميكي: أهداف متحركة + بيئات معقدة
4. التطبيق الوظيفي: قراءة + تنقل + أنشطة يومية

النتائج: تقليل زمن البحث 30-50%، تحسن القراءة والتنقل
مستوى الدليل: 1a (Cochrane) — التوصية: A
⚠️ لا يوسع المجال البصري — يحسن استراتيجيات التعويض
""",
        "tags": ["scanning", "hemianopia", "عمى شقي", "Zihl", "NeuroEyeCoach", "NEC",
                 "SEARCH", "stroke", "سكتة", "TBI", "مسح بصري", "Pollock", "Cochrane"]
    },
    # ─── تدريب المسح السمعي-البصري (AViST) ───
    {
        "id": "avist_protocol",
        "category": "protocols",
        "title": "تدريب المسح السمعي-البصري (AViST)",
        "text": """
تدريب المسح السمعي-البصري (Audio-Visual Scanning Training - AViST):
يجمع بين التنبيه السمعي والبصري لتحسين المسح في العمى الشقي.

المبدأ:
- تنبيه صوتي من الجانب المصاب يسبق الهدف البصري
- يستغل التكامل الحسي المتعدد (multisensory integration)
- يعزز توجيه الانتباه نحو المجال المفقود

البروتوكول:
1. تنبيه سمعي + بصري معاً (4-6 جلسات)
2. تقليل تدريجي للتنبيه السمعي (6-8 جلسات)
3. مسح بصري مستقل (4-6 جلسات)
المجموع: 14-20 جلسة، 45 دقيقة، 3×/أسبوع

الدليل العلمي:
- Keller 2010 RCT: AViST أفضل من visual scanning وحده
- تحسن اكتشاف الأهداف 40-60% في الجانب المصاب
- مفيد خاصةً عند وجود neglect خفيف

متطلبات: سمع كافٍ + قدرات إدراكية كافية
موانع: فقدان سمع ثنائي، ضعف إدراكي حاد

مستوى الدليل: 1b (RCT) — التوصية: A
المراجع: Keller 2010, Keller 2014
""",
        "tags": ["AViST", "audio-visual", "سمعي بصري", "scanning", "hemianopia",
                 "neglect", "multisensory", "Keller", "تكامل حسي"]
    },
    # ─── تأهيل حركات العين ───
    {
        "id": "oculomotor_rehab_protocol",
        "category": "protocols",
        "title": "تأهيل حركات العين (Oculomotor Rehabilitation) — Post-TBI",
        "text": """
تأهيل حركات العين بعد إصابات الدماغ الرضحية (TBI):

1. قصور التقارب (Convergence Insufficiency):
   - CITT Protocol (Convergence Insufficiency Treatment Trial):
     * 12 أسبوع جلسات أسبوعية 60 دقيقة
     * Hart chart + Brock string + Vectograms + Prism flippers
     * + تمارين منزلية يومية 15 دقيقة
   - CITT 2008 RCT: العلاج العيادي أفضل بشكل واضح من المنزلي
   - هدف: NPC < 6cm + CISS score < 16

2. اختلال المطابقة (Accommodative Dysfunction):
   - تمارين accommodative flippers (+2.00/-2.00)
   - Hart chart (near/far rock)
   - هدف: استعادة amplitude طبيعي حسب العمر

3. اختلال حركات العين السريعة (Saccadic Dysfunction):
   - تمارين saccadic targets متدرجة (سعة + سرعة + دقة)
   - KART (King-Devick + Anti-saccade Response Training)
   - هدف: تقليل latency وتحسين accuracy

معايير التحويل:
- NPC > 10cm → convergence therapy
- Accommodative amplitude < expected → accommodation therapy
- Abnormal DEM/NSUCO → saccadic training

مستويات الدليل:
- Convergence: 1b (CITT RCT) — التوصية: A
- Accommodation: 2b — التوصية: B
- Saccades: 2a — التوصية: B

المراجع: CITT 2008, Scheiman 2005, Ciuffreda 2007, Thiagarajan 2014
""",
        "tags": ["oculomotor", "حركات العين", "convergence", "تقارب", "accommodation",
                 "مطابقة", "saccades", "TBI", "concussion", "CITT", "Brock string"]
    },
    # ─── علاج التكيف المنشوري ───
    {
        "id": "prism_adaptation_protocol",
        "category": "protocols",
        "title": "علاج التكيف المنشوري للإهمال البصري (Prism Adaptation Therapy)",
        "text": """
علاج التكيف المنشوري (Prism Adaptation Therapy):
علاج فعال للإهمال البصري (visual neglect) بعد إصابة نصف الكرة الأيمن.

المبدأ:
- ارتداء نظارات منشورية (10° يمين) → تحريف الإدراك المكاني
- حركات إشارة متكررة → تكيف حركي-بصري
- بعد الإزالة: aftereffect = انحراف نحو اليسار (المهمل)

البروتوكول (Rossetti 1998):
1. تقييم الإهمال: Line bisection + Star cancellation + BIT battery
2. جلسة Prism Adaptation:
   - نظارات 10° prismatic shift يمين
   - 90 حركة إشارة لأهداف (50 مع رؤية اليد + 40 بدون)
   - المدة: 15-20 دقيقة
3. تقييم aftereffect: انحراف الإشارة نحو اليسار = نجاح
4. التكرار: يومياً أثناء التنويم / 3×/أسبوع خارجي
5. المجموع: 10-14 جلسة أساسية + 2-4 أسابيع تعزيز

النتائج:
- تحسن 40-60% في اختبارات الإهمال
- تأثير الجلسة الواحدة: ساعات إلى أيام
- التأثير التراكمي: أسابيع إلى أشهر
- تحسن في ADL والتنقل

⚠️ مهم: يجب علاج الإهمال أولاً قبل بدء Scanning Training
الإهمال يعيق فعالية تدريب المسح البصري!

مستوى الدليل: 1a (Multiple RCTs + Meta-analysis) — التوصية: A
المراجع: Rossetti 1998, Frassinetti 2002, Jacquin-Courtois 2013
""",
        "tags": ["prism adaptation", "تكيف منشوري", "neglect", "إهمال بصري",
                 "visual neglect", "stroke", "Rossetti", "aftereffect", "hemianopia"]
    },
    # ─── المناشير المحيطية ───
    {
        "id": "peripheral_prisms_guide",
        "category": "devices",
        "title": "المناشير المحيطية لتوسيع المجال البصري",
        "text": """
المناشير المحيطية (Peripheral Prisms):
أجهزة بصرية لتوسيع المجال الوظيفي في العمى الشقي.

الأنواع:
1. منشور Fresnel (Press-On):
   - قوة: 15-20 PD
   - مؤقت، رخيص، سهل التطبيق
   - يقلل وضوح الصورة قليلاً
   - مناسب للتجربة قبل الحل الدائم

2. منشور Peli 40PD (الدائم):
   - شرائح منشورية 40PD مثبتة على نظارة الحامل
   - موضع: علوي + سفلي في الجانب المصاب (يترك المركز خالياً)
   - المبدأ: تحويل الصورة المحيطية → تنبيه بوجود عوائق → المريض يدير رأسه
   - Bowers 2014 RCT: توسيع وظيفي ~20° + تحسن تجنب العوائق
   - ~60-70% من المرضى يستمرون بالاستخدام

3. Multi-Periscopic Prism (MPP):
   - تصميم بيريسكوبي متعدد الطبقات
   - قيد التطوير — نتائج أولية واعدة
   - Houston 2018, Jung 2020

التدريب:
- تعلم تفسير الازدواجية المحيطية كـ "تنبيه" وليس "تشويش"
- 2-4 أسابيع تكيف تدريجي
- يبدأ بالبيئة المنزلية ثم الخارجية

مستوى الدليل:
- Fresnel: 2b — التوصية: B
- Peli 40PD: 1b (RCT) — التوصية: A
- MPP: 3 — التوصية: C

المراجع: Peli 2000, Bowers 2014, Bowers 2008
""",
        "tags": ["prism", "منشور", "peripheral", "محيطي", "Fresnel", "Peli",
                 "40PD", "MPP", "hemianopia", "field expansion", "توسيع المجال"]
    },
    # ─── النظارات الذكية ───
    {
        "id": "smart_glasses_technology",
        "category": "devices",
        "title": "النظارات الذكية للتأهيل البصري",
        "text": """
النظارات الذكية (Smart Glasses) — تقنيات بديلة متقدمة:

1. eSight Go:
   - كاميرا عالية الدقة + شاشات OLED + تكبير حقيقي
   - يمكن تحسين VA إلى 20/20-20/40 أثناء الارتداء
   - مناسب لـ: VA ≥ CF + أي فقد غير كامل
   - الاستخدامات: قراءة + مسافة + كمبيوتر + TV
   - السعر: ~$6,000-$10,000

2. IrisVision Inspire:
   - VR headset مع Samsung Galaxy
   - تكبير + تباين + bubble view (توسيع محيطي)
   - مناسب لـ: VA ≥ 20/400
   - مميز: وضع bubble يوسع المجال للأنفاق
   - السعر: ~$3,000

3. OrCam MyEye 3:
   - كاميرا AI مصغرة تُثبت على أي نظارة
   - OCR فوري: قراءة نصوص + أوراق نقدية + باركود
   - التعرف على الوجوه المسجلة مسبقاً
   - لا يحتاج إنترنت (معالجة محلية)
   - مناسب لـ: أي مستوى فقد بصري حتى العمى الكامل
   - السعر: ~$4,000-$5,000

4. Vision Buddy:
   - نظارة مكبرة خاصة بمشاهدة التلفزيون
   - سعر أقل + استخدام محدد

5. Envision Glasses:
   - Google Glass frame مع AI
   - وصف المشاهد + قراءة نصوص + ألوان + عملات
   - يحتاج اتصال إنترنت

معايير الاختيار:
- eSight: أفضل لتحسين VA الفعلية (يحتاج بقايا رؤية)
- OrCam: أفضل للعمى الشديد/الكامل (AI بدلاً من التكبير)
- IrisVision: أفضل لـ tunnel vision (bubble view)

مستوى الدليل: 2b — التوصية: B
المراجع: Wittich 2018, Deemer 2018, Moisseiev 2019
""",
        "tags": ["smart glasses", "نظارات ذكية", "eSight", "IrisVision", "OrCam",
                 "AI", "تكنولوجيا مساعدة", "Vision Buddy", "Envision", "تكبير إلكتروني"]
    },
    # ─── تطبيقات الذكاء الاصطناعي ───
    {
        "id": "ai_vision_apps",
        "category": "devices",
        "title": "تطبيقات الذكاء الاصطناعي للمكفوفين وضعاف البصر",
        "text": """
تطبيقات AI للهواتف الذكية — مساعدة بصرية ذكية:

1. Be My Eyes + GPT-4V:
   - مساعد AI بصري: وصف المشاهد + قراءة + إرشاد
   - يمكن توجيه أسئلة محددة عن الصورة
   - مجاني + متاح بالعربية
   - يحتاج: هاتف ذكي + إنترنت

2. Seeing AI (Microsoft):
   - قراءة نصوص + عملات + ألوان + وصف مشاهد
   - وضع المستندات: يوجه المستخدم لتصوير صحيح
   - مجاني على iOS

3. Envision AI:
   - قراءة + وصف + التعرف على الوجوه
   - يعمل على Envision Glasses أو هاتف
   - اشتراك شهري

4. Supersense:
   - متخصص في قراءة النصوص + التعرف على العملات
   - واجهة بسيطة مناسبة لكبار السن

الاستخدام في التأهيل:
- مكمل (وليس بديلاً) للأجهزة البصرية التقليدية
- مفيد للمهام اللحظية: قراءة فاتورة، التعرف على منتج
- تدريب: 1-2 جلسات لتعلم الاستخدام
- تقييم: مدى ملاءمة التقنية لأهداف المريض

مستوى الدليل: 4 (تقارير مستخدمين) — التوصية: C
⚠️ لا تستبدل التأهيل المنظم — أداة مساعدة تكميلية
""",
        "tags": ["AI", "ذكاء اصطناعي", "Be My Eyes", "GPT-4", "Seeing AI",
                 "Envision", "تطبيقات", "هاتف ذكي", "OCR", "مكفوفين"]
    },
    # ─── علاج استعادة البصر (VRT) ───
    {
        "id": "vrt_controversy",
        "category": "protocols",
        "title": "علاج استعادة البصر (VRT) — مثير للجدل",
        "text": """
علاج استعادة البصر (Vision Restoration Therapy - VRT):
تقنية ترميمية مثيرة للجدل تهدف لتوسيع المجال البصري.

المبدأ: تحفيز متكرر لحدود المنطقة الانتقالية (transition zone) في المجال البصري
المدعى: إعادة تنشيط الخلايا العصبية شبه المتضررة

البروتوكول (NovaVision):
- HRP (High Resolution Perimetry) لتحديد المنطقة الانتقالية
- 30 دقيقة × 2 يومياً لمدة 6 أشهر
- تحفيز بومضات ضوئية على حدود العمى
- ~360 جلسة منزلية

الجدل:
✅ Kasten 1998: ادعى توسع 5° في المجال
❌ Reinhard 2005: لم يجد فرقاً عند ضبط حركات العين (eye movement confounds)
❌ Cochrane 2020: دليل غير كافٍ لدعم الاستخدام الروتيني

التفسير المحتمل:
- التحسن المبلغ قد يكون بسبب حركات عين تعويضية وليس توسعاً فعلياً
- قد يحسن الانتباه البصري أكثر من المجال الحقيقي
- Scanning Training أقل تكلفة وأقوى دليلاً

التوصية السريرية:
⚠️ لا يُوصى كخط أول — Scanning Training أفضل
⚠️ إذا اختار المريض: إبلاغ بالجدل + 6 أشهر التزام + تكلفة عالية
⚠️ مستوى الدليل: 2b (متضارب) — التوصية: C

المراجع: Kasten 1998, Reinhard 2005, Cochrane 2020
""",
        "tags": ["VRT", "vision restoration", "استعادة البصر", "NovaVision",
                 "مثير للجدل", "controversial", "transition zone", "hemianopia"]
    },
    # ─── التحفيز عبر الجمجمة ───
    {
        "id": "brain_stimulation_visual",
        "category": "protocols",
        "title": "التحفيز عبر الجمجمة (tDCS/tRNS) — تجريبي",
        "text": """
التحفيز عبر الجمجمة لتأهيل البصر — تقنية تجريبية:

1. tDCS (Transcranial Direct Current Stimulation):
   - تيار مستمر ضعيف (1-2 mA) عبر أقطاب على فروة الرأس
   - القطب الموجب على V1 المقابل → زيادة إثارة القشرة البصرية
   - البروتوكول: 20 دقيقة/جلسة × 10-20 جلسة × 5/أسبوع
   - Plow 2011: تحسن عابر في VF في بعض المرضى

2. tRNS (Transcranial Random Noise Stimulation):
   - ضوضاء عشوائية (0.1-640 Hz) بدلاً من تيار ثابت
   - آلية: stochastic resonance → تحسين signal detection
   - Herpich 2019: دراسات أولية فقط

الموانع:
- منظم قلب (pacemaker)
- تاريخ صرع
- زراعات معدنية في الجمجمة
- حمل

الحالة العلمية:
⚠️ تجريبي بالكامل — غير معتمد للاستخدام السريري الروتيني
⚠️ يجب إجراؤه فقط في سياق بحثي مع موافقة أخلاقية
⚠️ لا يوجد إثبات قاطع للفعالية طويلة المدى
⚠️ مستوى الدليل: 2b-3 — التوصية: C-D

المراجع: Plow 2011, Sabel 2020, Herpich 2019
""",
        "tags": ["tDCS", "tRNS", "تحفيز دماغي", "transcranial", "brain stimulation",
                 "تجريبي", "experimental", "V1", "visual cortex", "Sabel"]
    },
    # ─── العلاج الجيني ───
    {
        "id": "gene_therapy_visual",
        "category": "treatment_plans",
        "title": "العلاج الجيني البصري (Luxturna - RPE65)",
        "text": """
العلاج الجيني للأمراض الشبكية الوراثية:

Luxturna (Voretigene neparvovec-rzyl):
أول علاج جيني معتمد للعين (FDA 2017, EMA 2018).

الآلية:
- ناقل AAV2 يحمل نسخة سليمة من جين RPE65
- حقن تحت الشبكية (subretinal injection)
- يعيد وظيفة دورة retinoid → تحسن الرؤية في الإضاءة المنخفضة

الشروط:
- طفرة RPE65 ثنائية الأليل (biallelic) مؤكدة جينياً
- خلايا شبكية حية كافية (viable retinal cells)
- العمر ≥ 12 شهر
- لا يوجد عدوى نشطة أو ضمور شبكي متقدم

النتائج (Russell 2017 Phase III):
- تحسن MLMT بمعدل 1.6 مستوى إضاءة (مقابل 0.2 للمجموعة الضابطة)
- توسع المجال البصري (full-field stimulus testing)
- تحسن كبير في الرؤية الليلية
- Maguire 2019: تحسن مستمر لمدة 3+ سنوات

التكلفة والتوفر:
- ~$425,000 لكل عين
- يتطلب مركز جراحة شبكية معتمد
- متوفر في عدد محدود من المراكز عالمياً

مستوى الدليل: 1b (Phase III RCT) — التوصية: A (لـ RPE65 فقط)

⚠️ ملاحظات مهمة:
- فقط لطفرات RPE65 — لا يعالج أي طفرة أخرى
- أبحاث جارية لجينات أخرى: RPGR, CHM, CNGA3, CNGB3
- العلاج الجيني ليس "علاجاً شاملاً" — يحسن وظيفة محددة

المراجع: Russell 2017, Maguire 2019
""",
        "tags": ["gene therapy", "علاج جيني", "Luxturna", "RPE65", "AAV2",
                 "LCA", "retinitis pigmentosa", "RP", "شبكية", "وراثي"]
    },
    # ─── الشبكية الاصطناعية ───
    {
        "id": "retinal_prosthesis",
        "category": "devices",
        "title": "الشبكية الاصطناعية — الحالة الراهنة والمستقبل",
        "text": """
الشبكية الاصطناعية (Retinal Prosthesis):
أجهزة إلكترونية تحول الضوء إلى تحفيز كهربائي للشبكية.

1. Argus II (Second Sight) — متوقف:
   - أول شبكية اصطناعية معتمدة (FDA 2013)
   - 60 قطب كهربائي (6×10) على سطح الشبكية
   - كاميرا على نظارة → معالج → تحفيز
   - da Cruz 2016: ~350 مريض مزروع عالمياً
   - ⚠️ Second Sight أوقفت العمليات 2020 — لا دعم جديد

2. PRIMA (Pixium Vision) — قيد التطوير:
   - تصميم تحت-شبكي (subretinal) بدون كاميرا خارجية
   - نظارة خاصة تحول الصورة لأشعة تحت حمراء → الشريحة
   - مستهدف: AMD الجاف المتقدم
   - Phase I/II جارية (Palanker 2020)

3. Orion (Cortical) — قيد التطوير:
   - تحفيز مباشر للقشرة البصرية (V1)
   - لا يحتاج شبكية سليمة
   - مبكر جداً — feasibility studies

الحالة الراهنة:
⚠️ لا يوجد جهاز متاح تجارياً حالياً (2024-2025)
⚠️ Argus II: المرضى المزروعون يواجهون تحديات الدعم
⚠️ PRIMA وOrion: لا تزال في التجارب السريرية

مستوى الدليل:
- Argus II: 2b (N/A حالياً — متوقف)
- PRIMA: 3 (Phase I/II) — التوصية: D
- Orion: مبكر جداً

المراجع: da Cruz 2016, Palanker 2020
""",
        "tags": ["retinal prosthesis", "شبكية اصطناعية", "Argus", "PRIMA",
                 "Orion", "cortical", "bionic eye", "عين إلكترونية", "Pixium"]
    },
    # ─── التعلم الإدراكي ───
    {
        "id": "perceptual_learning_protocol",
        "category": "protocols",
        "title": "التعلم الإدراكي (Perceptual Learning) لتحسين الرؤية",
        "text": """
التعلم الإدراكي (Perceptual Learning):
تدريب متكرر على مهام بصرية محددة لتحسين الأداء البصري.

الآلية: اللدونة العصبية (neuroplasticity) في V1 وما بعدها

التقنيات:
1. Gabor Patches:
   - كشف شبكات Gabor بتباين متدرج
   - Adaptive staircase: الصعوبة تتكيف تلقائياً
   - Polat 2004 RCT: تحسن CS بـ 1-2 سطر

2. Lateral Masking:
   - كشف هدف مركزي مع flankers محيطية
   - يحسن تفاعلات المثبطة/المنشطة في V1
   - Huang 2008: تحسن VA في amblyopia

3. Crowding Reduction:
   - التعرف على حروف في ازدحام بصري
   - مفيد لتحسين القراءة مع scotoma

4. Motion Perception:
   - تدريب على إدراك الحركة (random dot kinematograms)
   - يحسن اكتشاف الحركة في المجال المحيطي

البروتوكول العام:
- 40-60 جلسة × 30 دقيقة × يومياً أو 5×/أسبوع
- قياس CS + VA كل 10 جلسات
- التحسن يظهر بعد 20-30 جلسة عادةً

القيود:
⚠️ النقل محدود — التحسن خاص بالمهمة المدربة
⚠️ يحتاج دافعية عالية ومواظبة

مستوى الدليل: 1b (RCTs) — التوصية: A
المراجع: Polat 2004, Levi 2009, Huang 2008
""",
        "tags": ["perceptual learning", "تعلم إدراكي", "Gabor", "contrast sensitivity",
                 "حساسية التباين", "lateral masking", "amblyopia", "neuroplasticity", "V1"]
    },
    # ─── التأهيل عن بعد ───
    {
        "id": "telerehab_low_vision",
        "category": "protocols",
        "title": "التأهيل البصري عن بعد (Telerehabilitation)",
        "text": """
التأهيل البصري عن بعد (Tele-Low Vision Rehabilitation):
تقديم خدمات التأهيل البصري عبر الفيديو.

الدليل الأساسي:
Bittner 2024 RCT (أكبر دراسة حتى الآن):
- تصميم: RCT متعدد المراكز
- المجموعات: تأهيل عن بعد vs. حضوري vs. مراقبة هاتفية
- النتيجة: التأهيل عن بعد مكافئ للحضوري (non-inferior)
- تحسن: VFQ-25 + قراءة + ADL + رضا
- الأهم: لا فرق جوهري في النتائج!

البروتوكول:
1. تقييم تقني: اتصال + معدات + إضاءة + كاميرا
2. تقييم بصري عن بعد: VA + contrast + وظائف
3. جلسات التأهيل (6-12 جلسة):
   - تدريب أجهزة مساعدة (عبر إرشاد بالفيديو)
   - EVT + استراتيجيات يومية
   - تعديلات بيئية (توجيه الكاميرا لأرجاء المنزل)
4. متابعة شهرية

المتطلبات:
- إنترنت مستقر + جهاز بكاميرا (tablet/computer)
- مُعرِّف (caregiver) إذا لزم الأمر لإعداد الجهاز
- بيئة هادئة مع إضاءة كافية

الفوائد:
- إتاحة الخدمة للمناطق النائية
- تقليل عبء السفر (خاصةً كبار السن)
- رضا المرضى >85%
- فعالية مكافئة بتكلفة أقل

مستوى الدليل: 1b (RCT) — التوصية: A
المراجع: Bittner 2024, Goldstein 2015
""",
        "tags": ["telerehab", "تأهيل عن بعد", "telemedicine", "video", "Bittner",
                 "remote", "عن بعد", "low vision", "VFQ-25"]
    },
    # ─── تأهيل القراءة المتقدم ───
    {
        "id": "advanced_reading_rehab",
        "category": "protocols",
        "title": "تأهيل القراءة المتقدم — RSVP وتقنيات حديثة",
        "text": """
تأهيل القراءة المتقدم (Advanced Reading Rehabilitation):

1. RSVP (Rapid Serial Visual Presentation):
   - عرض كلمة واحدة في المركز بدلاً من سطر كامل
   - يلغي الحاجة لحركات العين المسحية
   - مفيد جداً لـ: central scotoma + hemianopia
   - تطبيقات: Spritz, ReadQuick

2. Text-to-Speech Integration:
   - دمج OCR + TTS مع التدريب البصري
   - المريض يتابع النص بصرياً مع الصوت → تعزيز
   - يحسن سرعة القراءة والفهم معاً

3. تقنيات تكيفية:
   - تكبير + تباين عالٍ + خط واضح (Arial/Simplified Arabic)
   - إضاءة مثالية: 300+ لوكس + مصباح موجه
   - حامل كتب (book stand) لتثبيت مسافة العمل
   - مسطرة قراءة أو بطاقة إرشاد (typoscope)

4. القراءة العربية — اعتبارات خاصة:
   - اتجاه يمين→يسار: يؤثر على scanning pattern
   - النقاط والتشكيل: يتطلب contrast عالٍ + تكبير إضافي
   - القرآن الكريم: خطوط خاصة (عثماني) + تجويد (تلوين)
   - معامل التعقيد: عادي ×1.0, مشكّل ×1.3, قرآني ×1.4

هرمية التدخل:
1. تكبير + إضاءة + حامل (أساسي للجميع)
2. EVT/RSVP (لـ central scotoma)
3. Scanning + تكبير عمودي (لـ hemianopia)
4. TTS + OCR (للحالات المتقدمة أو العمى الكامل)
5. نظارات ذكية (إذا فشلت الخيارات الأخرى)
""",
        "tags": ["reading", "قراءة", "RSVP", "text-to-speech", "TTS", "OCR",
                 "تكبير", "contrast", "عربي", "قرآن", "typoscope"]
    },
    # ─── التعديلات البيئية والوقاية من السقوط ───
    {
        "id": "environmental_modifications_protocol",
        "category": "guidelines",
        "title": "التعديلات البيئية والوقاية من السقوط لضعف البصر",
        "text": """
التعديلات البيئية (Environmental Modifications):
تدخل أساسي لكل مريض ضعف بصر — أقوى دليل في الوقاية من السقوط.

الدليل:
- Campbell 2005 RCT: التعديلات المنزلية تقلل السقوط 41% في ضعاف البصر
- La Grow 2006: تأثير مستمر لمدة سنة

التقييم المنزلي (Home Assessment):
1. الإضاءة:
   - غرف المعيشة: ≥300 لوكس
   - القراءة: 500-1000 لوكس + مصباح موجه
   - السلالم: إضاءة موحدة + حواف مضيئة
   - تجنب: وهج (glare) + ظلال حادة + انتقالات مفاجئة

2. التباين:
   - حواف الدرج: شريط تباين (أصفر/أبيض)
   - مفاتيح الكهرباء: إطار ملون متباين
   - أدوات المطبخ: ألوان متباينة (لوح أبيض/أسود)
   - الحمام: مقابض ملونة على جدران فاتحة

3. إزالة العوائق:
   - السجاد المفكك → تثبيت أو إزالة
   - الأسلاك والكابلات → تنظيم وتثبيت
   - الأثاث البارز → إعادة ترتيب
   - الأرضيات الزلقة → مانعات انزلاق

4. أدوات السلامة:
   - مقابض في الحمام وعند السلالم
   - كرسي استحمام + مانع انزلاق حوض
   - هاتف طوارئ مبرمج + أرقام كبيرة
   - إنذار حريق صوتي (وليس بصري فقط)

5. تنظيم المنزل:
   - مكان ثابت لكل شيء (keys, wallet, medications)
   - تنظيم الأدوية: علب مقسمة + ملصقات كبيرة
   - ترقيم الأدوار بالبارز (tactile labels)

برنامج الوقاية من السقوط:
- تقييم منزلي + تعديلات (أعلاه)
- تمارين توازن: Otago Exercise Programme
- مراجعة الأدوية (sedatives, antihypertensives)
- فحص القدمين + الأحذية المناسبة

مستوى الدليل: 1b (RCT) — التوصية: A
المراجع: Campbell 2005, La Grow 2006, Otago Exercise Programme
""",
        "tags": ["environmental", "بيئة", "تعديلات", "سقوط", "fall prevention",
                 "إضاءة", "تباين", "contrast", "home safety", "Campbell", "Otago"]
    },
    # ─── برنامج الوقاية من السقوط ───
    {
        "id": "fall_prevention_visual_impairment",
        "category": "guidelines",
        "title": "برنامج الوقاية من السقوط لمرضى ضعف البصر",
        "text": """
برنامج الوقاية من السقوط المتكامل لضعف البصر:

الإحصائيات:
- مرضى ضعف البصر: خطر سقوط أعلى 1.7-2.5× من العاديين
- العوامل: ضعف إدراك العمق + العوائق + الإضاءة + التوازن

المكونات:
1. تعديلات بيئية (Campbell 2005 RCT):
   - تقييم + تعديل المنزل → تقليل السقوط 41%
   - الأكثر فعالية كتدخل منفرد

2. تمارين التوازن (Otago Exercise Programme):
   - تمارين تقوية + توازن × 30 دقيقة × 3/أسبوع
   - مشي × 30 دقيقة × 2/أسبوع (في بيئة آمنة)
   - مع OT أو physio في البداية ثم منزلي

3. مراجعة الأدوية:
   - المهدئات: تقليل أو إيقاف إن أمكن
   - خافضات الضغط: مراقبة orthostatic hypotension
   - مسكنات الألم: تقييم تأثيرها على التوازن

4. تصحيح بصري:
   - تحديث النظارة + إضاءة مناسبة
   - نظارة واحدة للمشي (ليست متعددة البؤر)
   - تجنب progressive lenses عند المشي والسلالم

5. تأهيل التنقل (O&M):
   - تدريب مع مختص O&M
   - العصا البيضاء إذا لزم
   - تقنيات traversing: سلالم + أرصفة + معابر

6. فحوصات إضافية:
   - فحص القدمين + أحذية مناسبة (flat, non-slip)
   - قياس vitamin D + تعويض إذا ناقص
   - تقييم سمع (التوازن الدهليزي)

تقييم الخطر:
- Falls Efficacy Scale (FES-I) > 23 = خطر عالٍ
- Timed Up and Go (TUG) > 14 ثانية = خطر عالٍ
- تاريخ سقوط ≥ 2 في آخر 12 شهر = خطر عالٍ

مستوى الدليل: 1a-1b — التوصية: A
المراجع: Campbell 2005, Gillespie 2012 Cochrane, Otago Programme
""",
        "tags": ["fall prevention", "سقوط", "توازن", "balance", "Otago",
                 "elderly", "كبار السن", "home safety", "O&M", "تنقل", "Campbell"]
    },
]


# ═══════════════════════════════════════════════════════════════
# محرك البحث (BM25-like TF-IDF)
# ═══════════════════════════════════════════════════════════════

def _tokenize(text: str) -> list:
    """تحليل النص إلى كلمات"""
    text = text.lower()
    # إزالة علامات الترقيم
    text = re.sub(r'[^\w\s\u0600-\u06FF]', ' ', text)
    return [w for w in text.split() if len(w) > 1]


def _compute_tf_idf_score(query_tokens: list, doc: dict) -> float:
    """حساب درجة التطابق بين الاستعلام والوثيقة"""
    doc_text = (doc.get("text", "") + " " + doc.get("title", "") + " " + " ".join(doc.get("tags", []))).lower()
    doc_tokens = _tokenize(doc_text)

    if not doc_tokens:
        return 0.0

    # TF: تكرار كل كلمة في الوثيقة
    score = 0.0
    for token in query_tokens:
        tf = doc_tokens.count(token) / len(doc_tokens)
        # زيادة وزن الكلمات في العنوان والتاجز
        title_boost = 3.0 if token in doc.get("title", "").lower() else 1.0
        tag_boost = 2.0 if any(token in tag.lower() for tag in doc.get("tags", [])) else 1.0
        score += tf * title_boost * tag_boost

    return score


def search_vector_db(params: dict) -> dict:
    """
    البحث في القاعدة المعرفية المحلية

    Args:
        params: {
            query (str): الاستعلام
            category (str): تصفية حسب الفئة (اختياري)
            top_k (int): عدد النتائج (افتراضي: 5)
        }
    """
    query = params.get("query", "")
    category = params.get("category")
    top_k = params.get("top_k", 5)

    if not query:
        return {"error": "يجب تحديد استعلام البحث"}

    # تصفية حسب الفئة
    docs = KNOWLEDGE_BASE
    if category:
        docs = [d for d in docs if d.get("category") == category]

    if not docs:
        return {
            "results": [],
            "message": f"لا توجد وثائق في الفئة: {category}"
        }

    # تحليل الاستعلام
    query_tokens = _tokenize(query)

    # حساب الدرجات
    scored_docs = []
    for doc in docs:
        score = _compute_tf_idf_score(query_tokens, doc)
        if score > 0:
            scored_docs.append((score, doc))

    # ترتيب حسب الصلة
    scored_docs.sort(key=lambda x: x[0], reverse=True)

    # إعداد النتائج
    results = []
    for score, doc in scored_docs[:top_k]:
        results.append({
            "title": doc.get("title", ""),
            "category": doc.get("category", ""),
            "text": doc.get("text", "").strip(),
            "tags": doc.get("tags", []),
            "relevance_score": round(score, 4),
            "source": f"قاعدة المعرفة المحلية — {doc.get('id', '')}"
        })

    if not results:
        return {
            "results": [],
            "query": query,
            "message": "لم يتم العثور على نتائج ذات صلة. جرب مصطلحات مختلفة."
        }

    return {
        "results": results,
        "total_found": len(results),
        "query": query,
        "category_filter": category or "الكل"
    }


def add_document_to_kb(doc: dict) -> bool:
    """
    إضافة وثيقة جديدة للقاعدة المعرفية

    Args:
        doc: {
            "id": str,
            "category": str,
            "title": str,
            "text": str,
            "tags": list
        }
    """
    required = ["id", "category", "title", "text"]
    for field in required:
        if field not in doc:
            return False

    KNOWLEDGE_BASE.append(doc)
    return True
