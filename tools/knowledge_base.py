"""
Knowledge Base — القاعدة المعرفية للتأهيل البصري
=================================================
RAG بسيط يعمل بدون Vector DB خارجي
يمكن توسيعه لاحقاً مع Pinecone أو ChromaDB
"""

import re
import math
from typing import Optional


# ═══════════════════════════════════════════════════════════════
# قاعدة البيانات المعرفية المدمجة (Embedded Knowledge Base)
# ═══════════════════════════════════════════════════════════════

KNOWLEDGE_BASE = [
    # ─── إرشادات WHO ───
    {
        "id": "who_vi_classification",
        "category": "guidelines",
        "title": "تصنيف WHO لضعف البصر (ICD-11)",
        "text": """
تصنيف منظمة الصحة العالمية (WHO) لضعف البصر حسب ICD-11:
- الفئة 0 (طبيعي): حدة إبصار ≥ 6/18 (0.3 decimal)
- الفئة 1 (ضعف معتدل): 6/18 - 6/60 (0.1-0.3 decimal)
- الفئة 2 (ضعف شديد): 6/60 - 3/60 (0.05-0.1 decimal)
- الفئة 3 (ضعف عميق): 3/60 - 1/60 (0.02-0.05 decimal)
- الفئة 4 (إدراك الضوء): 1/60 - Light Perception
- الفئة 5 (عمى كامل): No Light Perception (NLP)
المجال البصري < 10° يُصنف إعاقة بصرية حتى لو كانت حدة الإبصار جيدة.
""",
        "tags": ["WHO", "ICD-11", "تصنيف", "ضعف البصر", "عمى"]
    },
    # ─── بروتوكول AMD ───
    {
        "id": "amd_rehab_protocol",
        "category": "treatment_plans",
        "title": "بروتوكول تأهيل الضمور البقعي المرتبط بالعمر (AMD)",
        "text": """
بروتوكول التأهيل البصري لمرضى AMD:

المرحلة الأولى — التقييم الأساسي:
- قياس حدة الإبصار المركزية والمحيطية
- فحص Amsler Grid لتحديد Scotoma المركزي
- تقييم حساسية التباين (Pelli-Robson)
- تقييم الوظائف البصرية اليومية (VFQ-25)
- فحص المجال البصري

المرحلة الثانية — الأهداف والتدخلات:
1. تدريب PRL (Preferred Retinal Locus):
   - تدريب المريض على استخدام منطقة شبكية صحية بدلاً من المركز
   - تقنية Steady Eye Strategy
   - مدة التدريب: 4-8 أسابيع، 3 مرات/أسبوع

2. الأجهزة المساعدة:
   - للقراءة القريبة: مكبرات عدسية (4-12x) أو مكبرات إلكترونية
   - للمسافة: منظار أحادي أو ثنائي (2-4x)
   - للكمبيوتر: تكبير الشاشة + High Contrast settings
   - CCTVs/EVES: للقراءة المطولة

3. تحسينات بيئية:
   - زيادة الإضاءة (500-1000 lux)
   - تقليل الوهج (Anti-glare filters)
   - تباين عالٍ في المطبوعات (أسود على أبيض)

المرحلة الثالثة — متابعة وتقييم:
- تقييم بعد 4 أسابيع
- قياس: سرعة القراءة، دقة القراءة، رضا المريض
- تعديل الخطة حسب التقدم
""",
        "tags": ["AMD", "ضمور بقعي", "تأهيل", "PRL", "مكبرات"]
    },
    # ─── السكري واعتلال الشبكية ───
    {
        "id": "diabetic_retinopathy_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية السكري",
        "text": """
تأهيل اعتلال الشبكية السكري (Diabetic Retinopathy Rehabilitation):

التحديات الخاصة:
- تذبذب حدة الإبصار مع مستويات السكر
- Scotomas متعددة وغير منتظمة
- مشاكل رؤية الألوان والتباين
- احتمال تدهور الحالة

بروتوكول التقييم:
- حدة الإبصار (مع وبدون تصحيح)
- فحص شامل للمجال البصري
- حساسية التباين (يتأثر مبكراً)
- ETDRS Visual Acuity للمتابعة الدقيقة

التدخلات:
1. إدارة ظروف القراءة:
   - إضاءة متحكم بها (تجنب الوهج)
   - استخدام Typoscope لتحديد السطر
   - قراءة بفترات قصيرة

2. الأجهزة:
   - مكبرات بيضاء/زرقاء لتحسين التباين
   - OCR software (Text-to-Speech)
   - Screen Magnification Software

3. تدريب التكيف البصري:
   - تمارين التكيف مع التغييرات البصرية
   - تقنيات التنقل مع ضعف البصر

مؤشرات التقدم:
- معدل القراءة بالكلمات/دقيقة
- نتائج VFQ-25
- مستوى الاعتماد الذاتي في الأنشطة اليومية
""",
        "tags": ["سكري", "اعتلال الشبكية", "تأهيل", "التباين"]
    },
    # ─── الجلوكوما ───
    {
        "id": "glaucoma_rehabilitation",
        "category": "treatment_plans",
        "title": "تأهيل الجلوكوما (الزرق)",
        "text": """
التأهيل البصري لمرضى الجلوكوما:

خصائص الحالة:
- فقدان محيطي أولاً في معظم الحالات
- المركز يُحفظ حتى مراحل متأخرة
- تأثير على التنقل والتوجه أكثر من القراءة

أهداف التأهيل:
1. تحسين التنقل والسلامة
2. تعويض الفقد المحيطي
3. تحسين الوضوء في الإضاءة المنخفضة

التدخلات:
1. برامج Orientation & Mobility (O&M):
   - تدريب على استخدام العصا البيضاء
   - التنقل في البيئات المألوفة والجديدة
   - استخدام الحواس الأخرى تعويضياً

2. تقنيات تعزيز المجال البصري:
   - Prism glasses للتنبيه المحيطي (مناقشات حول الفعالية)
   - Scanning Techniques: تدريب تحريك الرأس والعين

3. تعديلات المنزل والبيئة:
   - تحسين الإضاءة خاصةً في الدرج والممرات
   - إزالة عقبات في مسارات المشي
   - تباين لوني للأثاث والدرج

معايير النجاح:
- اختبار Mobility Course قبل وبعد
- VFQ-25 قسم التنقل
- عدد حوادث السقوط
""",
        "tags": ["جلوكوما", "زرق", "تنقل", "O&M", "محيطي"]
    },
    # ─── أجهزة مساعدة بصرية ───
    {
        "id": "optical_devices_guide",
        "category": "devices",
        "title": "دليل الأجهزة البصرية المساعدة",
        "text": """
أنواع الأجهزة البصرية المساعدة:

أولاً — أجهزة القراءة القريبة:
1. العدسات المكبرة اليدوية (Hand Magnifiers):
   - مناسبة للاستخدام المؤقت وقراءة العلامات
   - نطاق: 2x-10x
   - ميزة: رخيصة، سهلة الاستخدام
   - عيب: تحتاج يداً حرة، مسافة عمل قصيرة

2. العدسات المكبرة المستقلة (Stand Magnifiers):
   - للقراءة المطولة على السطح
   - نطاق: 2x-15x
   - ميزة: مسافة عمل ثابتة، لا تحتاج تثبيت
   - مناسبة لكبار السن ومرضى رعاش اليد

3. النظارات التلسكوبية (Spectacle Telescopes):
   - للمسافات البعيدة (TV، اللوح، الأفراد)
   - نطاق: 2.2x-4x
   - ميزة: تحرر اليدين
   - عيب: مجال رؤية ضيق

4. المكبرات الإلكترونية (CCTV/EVES):
   - للقراءة والكتابة والمهام الدقيقة
   - التكبير: 2x-70x
   - مزايا: تحكم في التباين والألوان، يمكن عكس الألوان
   - أنواع: طاولي، محمول (مثل Optelec Compact)

ثانياً — تقنيات مساعدة رقمية:
1. Screen Magnification Software:
   - ZoomText, Windows Magnifier, macOS Zoom
   - تكبير 2x-36x مع تتبع الماوس

2. Screen Readers:
   - NVDA (مجاني)، JAWS، VoiceOver
   - مناسبة لضعف البصر الشديد والعمى

3. OCR & Text-to-Speech:
   - OrCam MyEye: جهاز مثبت على النظارة
   - Seeing AI (Microsoft): تطبيق مجاني

اعتبارات الاختيار:
- نوع وشدة ضعف البصر
- طبيعة المهام اليومية المطلوبة
- المهارة في استخدام التقنية
- التكلفة والتأمين الصحي
- قدرة حمل الجهاز واستخدامه
""",
        "tags": ["أجهزة مساعدة", "مكبرات", "CCTV", "تقنية"]
    },
    # ─── بروتوكول التقييم الوظيفي ───
    {
        "id": "functional_assessment_protocol",
        "category": "assessments",
        "title": "بروتوكول التقييم الوظيفي البصري",
        "text": """
بروتوكول التقييم الوظيفي البصري الشامل:

المرحلة 1 — المقابلة وجمع التاريخ:
- التشخيص الطبي وتاريخ المرض
- الشكاوى الوظيفية الرئيسية
- الأهداف والاحتياجات اليومية
- التاريخ الدوائي (خاصةً مؤثرات العيون)
- الحالات الصحية المصاحبة
- الوضع الأسري والمهني والاجتماعي

المرحلة 2 — الفحص البصري:
أ) حدة الإبصار:
   - ETDRS Chart (أفضل دقة)
   - Bailey-Lovie LogMAR Chart
   - Snellen Chart (أقل دقة لكن شائع)
   - قياس للعين اليمنى، اليسرى، ثم كلتيهما

ب) المجال البصري:
   - Confrontation Fields (سريع للشاشة)
   - Amsler Grid (المركز 10°)
   - Humphrey Automated Perimetry (إن توفر)

ج) حساسية التباين:
   - Pelli-Robson Chart
   - Mars Letter Contrast Sensitivity Test

د) رؤية الألوان (عند الحاجة):
   - Farnsworth-Munsell 100-Hue Test

المرحلة 3 — تقييم الوظائف الحياتية:
- MNREAD Acuity Chart: سرعة ودقة القراءة
- Pepper VSRT: مهارات القراءة الوظيفية
- VFQ-25 استبيان: جودة الحياة البصرية
- Melbourne Low Vision ADL Index

المرحلة 4 — تجربة الأجهزة:
- تجربة مكبرات متنوعة
- تحديد القوة المثلى
- تدريب استخدامي مبدئي

التوثيق:
- استخدام نماذج SOAP أو ICF
- صور/مخططات عند الحاجة
- جلسة متابعة بعد 4-6 أسابيع
""",
        "tags": ["تقييم", "MNREAD", "VFQ-25", "بروتوكول", "وظيفي"]
    },
    # ─── تمارين بصرية ───
    {
        "id": "visual_exercises",
        "category": "exercises",
        "title": "تمارين التأهيل البصري والإدراك",
        "text": """
تمارين التأهيل البصري:

1. تمارين تدريب PRL (Preferred Retinal Locus):
   الهدف: تدريب المريض على استخدام المنطقة الشبكية الصحية
   التقنية:
   - استخدام برامج الحاسب (Macular Degeneration App)
   - تمارين تتبع النقاط على شاشة محكومة
   - تمارين Monocular Steady Eye Strategy
   التكرار: 20 دقيقة يومياً، 3 مرات/أسبوع

2. تمارين تعزيز المجال البصري المحيطي:
   الهدف: تحسين الوعي المحيطي لمرضى Scotoma المركزي
   التمرين:
   - تحريك الرأس والعين بشكل منهجي (Scanning)
   - تتبع أشياء متحركة في المجال المحيطي
   - تمارين التنبه للحركة من الأطراف

3. تدريب إدراك التباين:
   الهدف: تحسين قدرة التمييز في الإضاءة المنخفضة
   التمرين:
   - قراءة نصوص بتباينات متدرجة
   - تمييز الأشياء في ظروف إضاءة متغيرة
   - تمارين تمييز الوجوه والتعبيرات

4. تمارين تنسيق اليد-العين:
   الهدف: تحسين المهارات الدقيقة مع ضعف البصر
   التمرين:
   - خياطة ورسم مع مكبر
   - استخدام أدوات الإنجاز اليومي بشكل آمن
   - تمارين Peg Board

5. تمارين التحمل البصري:
   الهدف: زيادة مدة القراءة دون إجهاد
   البروتوكول:
   - البدء بـ 5 دقائق قراءة مريحة
   - زيادة 2 دقيقة كل أسبوع
   - استراحات منتظمة (20-20-20: كل 20 دقيقة، انظر 20 قدماً لمدة 20 ثانية)
""",
        "tags": ["تمارين", "PRL", "تأهيل", "تدريب", "إدراك بصري"]
    },
]


# ═══════════════════════════════════════════════════════════════
# محرك البحث (BM25-like TF-IDF)
# ═══════════════════════════════════════════════════════════════

def _tokenize(text: str) -> list:
    """تحليل النص إلى كلمات"""
    text = text.lower()
    # إزالة علامات الترقيم
    text = re.sub(r'[^\w\s\u0600-\u06FF]', ' ', text)
    return [w for w in text.split() if len(w) > 1]


def _compute_tf_idf_score(query_tokens: list, doc: dict) -> float:
    """حساب درجة التطابق بين الاستعلام والوثيقة"""
    doc_text = (doc.get("text", "") + " " + doc.get("title", "") + " " + " ".join(doc.get("tags", []))).lower()
    doc_tokens = _tokenize(doc_text)

    if not doc_tokens:
        return 0.0

    # TF: تكرار كل كلمة في الوثيقة
    score = 0.0
    for token in query_tokens:
        tf = doc_tokens.count(token) / len(doc_tokens)
        # زيادة وزن الكلمات في العنوان والتاجز
        title_boost = 3.0 if token in doc.get("title", "").lower() else 1.0
        tag_boost = 2.0 if any(token in tag.lower() for tag in doc.get("tags", [])) else 1.0
        score += tf * title_boost * tag_boost

    return score


def search_vector_db(params: dict) -> dict:
    """
    البحث في القاعدة المعرفية المحلية

    Args:
        params: {
            query (str): الاستعلام
            category (str): تصفية حسب الفئة (اختياري)
            top_k (int): عدد النتائج (افتراضي: 5)
        }
    """
    query = params.get("query", "")
    category = params.get("category")
    top_k = params.get("top_k", 5)

    if not query:
        return {"error": "يجب تحديد استعلام البحث"}

    # تصفية حسب الفئة
    docs = KNOWLEDGE_BASE
    if category:
        docs = [d for d in docs if d.get("category") == category]

    if not docs:
        return {
            "results": [],
            "message": f"لا توجد وثائق في الفئة: {category}"
        }

    # تحليل الاستعلام
    query_tokens = _tokenize(query)

    # حساب الدرجات
    scored_docs = []
    for doc in docs:
        score = _compute_tf_idf_score(query_tokens, doc)
        if score > 0:
            scored_docs.append((score, doc))

    # ترتيب حسب الصلة
    scored_docs.sort(key=lambda x: x[0], reverse=True)

    # إعداد النتائج
    results = []
    for score, doc in scored_docs[:top_k]:
        results.append({
            "title": doc.get("title", ""),
            "category": doc.get("category", ""),
            "text": doc.get("text", "").strip(),
            "tags": doc.get("tags", []),
            "relevance_score": round(score, 4),
            "source": f"قاعدة المعرفة المحلية — {doc.get('id', '')}"
        })

    if not results:
        return {
            "results": [],
            "query": query,
            "message": "لم يتم العثور على نتائج ذات صلة. جرب مصطلحات مختلفة."
        }

    return {
        "results": results,
        "total_found": len(results),
        "query": query,
        "category_filter": category or "الكل"
    }


def add_document_to_kb(doc: dict) -> bool:
    """
    إضافة وثيقة جديدة للقاعدة المعرفية

    Args:
        doc: {
            "id": str,
            "category": str,
            "title": str,
            "text": str,
            "tags": list
        }
    """
    required = ["id", "category", "title", "text"]
    for field in required:
        if field not in doc:
            return False

    KNOWLEDGE_BASE.append(doc)
    return True
