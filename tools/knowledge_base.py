"""
Knowledge Base — القاعدة المعرفية للتأهيل البصري
=================================================
RAG بسيط يعمل بدون Vector DB خارجي
يمكن توسيعه لاحقاً مع Pinecone أو ChromaDB
"""

import re
import math
from typing import Optional


# ═══════════════════════════════════════════════════════════════
# قاعدة البيانات المعرفية المدمجة (Embedded Knowledge Base)
# ═══════════════════════════════════════════════════════════════

KNOWLEDGE_BASE = [
    # ─── إرشادات WHO ───
    {
        "id": "who_vi_classification",
        "category": "guidelines",
        "title": "تصنيف WHO لضعف البصر (ICD-11)",
        "text": """
تصنيف منظمة الصحة العالمية (WHO) لضعف البصر حسب ICD-11:
- الفئة 0 (طبيعي): حدة إبصار ≥ 6/18 (0.3 decimal)
- الفئة 1 (ضعف معتدل): 6/18 - 6/60 (0.1-0.3 decimal)
- الفئة 2 (ضعف شديد): 6/60 - 3/60 (0.05-0.1 decimal)
- الفئة 3 (ضعف عميق): 3/60 - 1/60 (0.02-0.05 decimal)
- الفئة 4 (إدراك الضوء): 1/60 - Light Perception
- الفئة 5 (عمى كامل): No Light Perception (NLP)
المجال البصري < 10° يُصنف إعاقة بصرية حتى لو كانت حدة الإبصار جيدة.
""",
        "tags": ["WHO", "ICD-11", "تصنيف", "ضعف البصر", "عمى"]
    },
    # ─── بروتوكول AMD ───
    {
        "id": "amd_rehab_protocol",
        "category": "treatment_plans",
        "title": "بروتوكول تأهيل الضمور البقعي المرتبط بالعمر (AMD)",
        "text": """
بروتوكول التأهيل البصري لمرضى AMD:

المرحلة الأولى — التقييم الأساسي:
- قياس حدة الإبصار المركزية والمحيطية
- فحص Amsler Grid لتحديد Scotoma المركزي
- تقييم حساسية التباين (Pelli-Robson)
- تقييم الوظائف البصرية اليومية (VFQ-25)
- فحص المجال البصري

المرحلة الثانية — الأهداف والتدخلات:
1. تدريب PRL (Preferred Retinal Locus):
   - تدريب المريض على استخدام منطقة شبكية صحية بدلاً من المركز
   - تقنية Steady Eye Strategy
   - مدة التدريب: 4-8 أسابيع، 3 مرات/أسبوع

2. الأجهزة المساعدة:
   - للقراءة القريبة: مكبرات عدسية (4-12x) أو مكبرات إلكترونية
   - للمسافة: منظار أحادي أو ثنائي (2-4x)
   - للكمبيوتر: تكبير الشاشة + High Contrast settings
   - CCTVs/EVES: للقراءة المطولة

3. تحسينات بيئية:
   - زيادة الإضاءة (500-1000 lux)
   - تقليل الوهج (Anti-glare filters)
   - تباين عالٍ في المطبوعات (أسود على أبيض)

المرحلة الثالثة — متابعة وتقييم:
- تقييم بعد 4 أسابيع
- قياس: سرعة القراءة، دقة القراءة، رضا المريض
- تعديل الخطة حسب التقدم
""",
        "tags": ["AMD", "ضمور بقعي", "تأهيل", "PRL", "مكبرات"]
    },
    # ─── السكري واعتلال الشبكية ───
    {
        "id": "diabetic_retinopathy_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية السكري",
        "text": """
تأهيل اعتلال الشبكية السكري (Diabetic Retinopathy Rehabilitation):

التحديات الخاصة:
- تذبذب حدة الإبصار مع مستويات السكر
- Scotomas متعددة وغير منتظمة
- مشاكل رؤية الألوان والتباين
- احتمال تدهور الحالة

بروتوكول التقييم:
- حدة الإبصار (مع وبدون تصحيح)
- فحص شامل للمجال البصري
- حساسية التباين (يتأثر مبكراً)
- ETDRS Visual Acuity للمتابعة الدقيقة

التدخلات:
1. إدارة ظروف القراءة:
   - إضاءة متحكم بها (تجنب الوهج)
   - استخدام Typoscope لتحديد السطر
   - قراءة بفترات قصيرة

2. الأجهزة:
   - مكبرات بيضاء/زرقاء لتحسين التباين
   - OCR software (Text-to-Speech)
   - Screen Magnification Software

3. تدريب التكيف البصري:
   - تمارين التكيف مع التغييرات البصرية
   - تقنيات التنقل مع ضعف البصر

مؤشرات التقدم:
- معدل القراءة بالكلمات/دقيقة
- نتائج VFQ-25
- مستوى الاعتماد الذاتي في الأنشطة اليومية
""",
        "tags": ["سكري", "اعتلال الشبكية", "تأهيل", "التباين"]
    },
    # ─── الجلوكوما ───
    {
        "id": "glaucoma_rehabilitation",
        "category": "treatment_plans",
        "title": "تأهيل الجلوكوما (الزرق)",
        "text": """
التأهيل البصري لمرضى الجلوكوما:

خصائص الحالة:
- فقدان محيطي أولاً في معظم الحالات
- المركز يُحفظ حتى مراحل متأخرة
- تأثير على التنقل والتوجه أكثر من القراءة

أهداف التأهيل:
1. تحسين التنقل والسلامة
2. تعويض الفقد المحيطي
3. تحسين الوضوء في الإضاءة المنخفضة

التدخلات:
1. برامج Orientation & Mobility (O&M):
   - تدريب على استخدام العصا البيضاء
   - التنقل في البيئات المألوفة والجديدة
   - استخدام الحواس الأخرى تعويضياً

2. تقنيات تعزيز المجال البصري:
   - Prism glasses للتنبيه المحيطي (مناقشات حول الفعالية)
   - Scanning Techniques: تدريب تحريك الرأس والعين

3. تعديلات المنزل والبيئة:
   - تحسين الإضاءة خاصةً في الدرج والممرات
   - إزالة عقبات في مسارات المشي
   - تباين لوني للأثاث والدرج

معايير النجاح:
- اختبار Mobility Course قبل وبعد
- VFQ-25 قسم التنقل
- عدد حوادث السقوط
""",
        "tags": ["جلوكوما", "زرق", "تنقل", "O&M", "محيطي"]
    },
    # ─── أجهزة مساعدة بصرية ───
    {
        "id": "optical_devices_guide",
        "category": "devices",
        "title": "دليل الأجهزة البصرية المساعدة",
        "text": """
أنواع الأجهزة البصرية المساعدة:

أولاً — أجهزة القراءة القريبة:
1. العدسات المكبرة اليدوية (Hand Magnifiers):
   - مناسبة للاستخدام المؤقت وقراءة العلامات
   - نطاق: 2x-10x
   - ميزة: رخيصة، سهلة الاستخدام
   - عيب: تحتاج يداً حرة، مسافة عمل قصيرة

2. العدسات المكبرة المستقلة (Stand Magnifiers):
   - للقراءة المطولة على السطح
   - نطاق: 2x-15x
   - ميزة: مسافة عمل ثابتة، لا تحتاج تثبيت
   - مناسبة لكبار السن ومرضى رعاش اليد

3. النظارات التلسكوبية (Spectacle Telescopes):
   - للمسافات البعيدة (TV، اللوح، الأفراد)
   - نطاق: 2.2x-4x
   - ميزة: تحرر اليدين
   - عيب: مجال رؤية ضيق

4. المكبرات الإلكترونية (CCTV/EVES):
   - للقراءة والكتابة والمهام الدقيقة
   - التكبير: 2x-70x
   - مزايا: تحكم في التباين والألوان، يمكن عكس الألوان
   - أنواع: طاولي، محمول (مثل Optelec Compact)

ثانياً — تقنيات مساعدة رقمية:
1. Screen Magnification Software:
   - ZoomText, Windows Magnifier, macOS Zoom
   - تكبير 2x-36x مع تتبع الماوس

2. Screen Readers:
   - NVDA (مجاني)، JAWS، VoiceOver
   - مناسبة لضعف البصر الشديد والعمى

3. OCR & Text-to-Speech:
   - OrCam MyEye: جهاز مثبت على النظارة
   - Seeing AI (Microsoft): تطبيق مجاني

اعتبارات الاختيار:
- نوع وشدة ضعف البصر
- طبيعة المهام اليومية المطلوبة
- المهارة في استخدام التقنية
- التكلفة والتأمين الصحي
- قدرة حمل الجهاز واستخدامه
""",
        "tags": ["أجهزة مساعدة", "مكبرات", "CCTV", "تقنية"]
    },
    # ─── بروتوكول التقييم الوظيفي ───
    {
        "id": "functional_assessment_protocol",
        "category": "assessments",
        "title": "بروتوكول التقييم الوظيفي البصري",
        "text": """
بروتوكول التقييم الوظيفي البصري الشامل:

المرحلة 1 — المقابلة وجمع التاريخ:
- التشخيص الطبي وتاريخ المرض
- الشكاوى الوظيفية الرئيسية
- الأهداف والاحتياجات اليومية
- التاريخ الدوائي (خاصةً مؤثرات العيون)
- الحالات الصحية المصاحبة
- الوضع الأسري والمهني والاجتماعي

المرحلة 2 — الفحص البصري:
أ) حدة الإبصار:
   - ETDRS Chart (أفضل دقة)
   - Bailey-Lovie LogMAR Chart
   - Snellen Chart (أقل دقة لكن شائع)
   - قياس للعين اليمنى، اليسرى، ثم كلتيهما

ب) المجال البصري:
   - Confrontation Fields (سريع للشاشة)
   - Amsler Grid (المركز 10°)
   - Humphrey Automated Perimetry (إن توفر)

ج) حساسية التباين:
   - Pelli-Robson Chart
   - Mars Letter Contrast Sensitivity Test

د) رؤية الألوان (عند الحاجة):
   - Farnsworth-Munsell 100-Hue Test

المرحلة 3 — تقييم الوظائف الحياتية:
- MNREAD Acuity Chart: سرعة ودقة القراءة
- Pepper VSRT: مهارات القراءة الوظيفية
- VFQ-25 استبيان: جودة الحياة البصرية
- Melbourne Low Vision ADL Index

المرحلة 4 — تجربة الأجهزة:
- تجربة مكبرات متنوعة
- تحديد القوة المثلى
- تدريب استخدامي مبدئي

التوثيق:
- استخدام نماذج SOAP أو ICF
- صور/مخططات عند الحاجة
- جلسة متابعة بعد 4-6 أسابيع
""",
        "tags": ["تقييم", "MNREAD", "VFQ-25", "بروتوكول", "وظيفي"]
    },
    # ─── تمارين بصرية ───
    {
        "id": "visual_exercises",
        "category": "exercises",
        "title": "تمارين التأهيل البصري والإدراك",
        "text": """
تمارين التأهيل البصري:

1. تمارين تدريب PRL (Preferred Retinal Locus):
   الهدف: تدريب المريض على استخدام المنطقة الشبكية الصحية
   التقنية:
   - استخدام برامج الحاسب (Macular Degeneration App)
   - تمارين تتبع النقاط على شاشة محكومة
   - تمارين Monocular Steady Eye Strategy
   التكرار: 20 دقيقة يومياً، 3 مرات/أسبوع

2. تمارين تعزيز المجال البصري المحيطي:
   الهدف: تحسين الوعي المحيطي لمرضى Scotoma المركزي
   التمرين:
   - تحريك الرأس والعين بشكل منهجي (Scanning)
   - تتبع أشياء متحركة في المجال المحيطي
   - تمارين التنبه للحركة من الأطراف

3. تدريب إدراك التباين:
   الهدف: تحسين قدرة التمييز في الإضاءة المنخفضة
   التمرين:
   - قراءة نصوص بتباينات متدرجة
   - تمييز الأشياء في ظروف إضاءة متغيرة
   - تمارين تمييز الوجوه والتعبيرات

4. تمارين تنسيق اليد-العين:
   الهدف: تحسين المهارات الدقيقة مع ضعف البصر
   التمرين:
   - خياطة ورسم مع مكبر
   - استخدام أدوات الإنجاز اليومي بشكل آمن
   - تمارين Peg Board

5. تمارين التحمل البصري:
   الهدف: زيادة مدة القراءة دون إجهاد
   البروتوكول:
   - البدء بـ 5 دقائق قراءة مريحة
   - زيادة 2 دقيقة كل أسبوع
   - استراحات منتظمة (20-20-20: كل 20 دقيقة، انظر 20 قدماً لمدة 20 ثانية)
""",
        "tags": ["تمارين", "PRL", "تأهيل", "تدريب", "إدراك بصري"]
    },

    # ─── تأهيل الأطفال — CVI ───
    {
        "id": "cvi_pediatric_rehab",
        "category": "treatment_plans",
        "title": "تأهيل الإعاقة البصرية القشرية لدى الأطفال (CVI)",
        "text": """
الإعاقة البصرية القشرية (Cortical Visual Impairment - CVI):

التعريف والخصائص:
- أكثر أسباب ضعف البصر شيوعاً في الأطفال في الدول المتطورة
- الضرر في المسارات البصرية القشرية لا في العين ذاتها
- السمات: قد تكون حدة الإبصار الأمامية طبيعية مع ضعف معالجة بصرية

علامات CVI عند الأطفال:
- التحديق في الأضواء (Light Gazing)
- تفضيل الألوان الزاهية (خاصةً الأحمر والأصفر)
- صعوبة في الوجوه والمشاهد المعقدة (Visual Complexity)
- تحسن الرؤية في بيئات هادئة وبسيطة (Field Preference)
- Latency بصرية (تأخر الاستجابة البصرية)
- استخدام الرؤية المحيطية أحياناً

مراحل CVI (Roman Scale):
- المرحلة I (1-3): اهتمام بصري محدود، ضوء ولون فقط
- المرحلة II (4-6): تحسن الاهتمام، تمييز أشياء مألوفة
- المرحلة III (7-10): رؤية وظيفية جيدة، صعوبات في التعقيد

بروتوكول التدخل:
1. تبسيط البيئة البصرية (Visual Complexity Reduction)
2. استخدام ألوان زاهية ومألوفة
3. تقليل المثيرات المشتتة
4. زيادة حجم الأشياء تدريجياً
5. التدريب مع ضوء خلفي للأجهزة اللوحية
6. برامج Computer-based visual stimulation

الأهداف التعليمية:
- التنسيق مع المدرسة لتكييف البيئة الصفية
- تدريب المعلم على احتياجات CVI
- استخدام الـ iPad مع تطبيقات CVI المخصصة
""",
        "tags": ["CVI", "أطفال", "قشري", "تأهيل", "بصري", "تدخل مبكر"]
    },

    # ─── ضعف البصر عند الخدج (LMA) ───
    {
        "id": "lma_premature_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية عند الخدج (ROP/LMA)",
        "text": """
اعتلال شبكية الخدج (Retinopathy of Prematurity - ROP):

التصنيف والمراحل:
- المرحلة 1: خط ترسيم رفيع
- المرحلة 2: حافة أو نتوء
- المرحلة 3: نسيج ليفي وعائي خارج الشبكية
- المرحلة 4: انفصال جزئي للشبكية (4A: دون مركز، 4B: مع مركز)
- المرحلة 5: انفصال كامل للشبكية

Plus Disease: وعائية متضخمة متلوية = مؤشر للعلاج

التدخل العلاجي:
- Zone I/II + Stage 3 + Plus: علاج بالليزر أو Avastin
- Zone II/III Stage 1-2: مراقبة
- Stage 4-5: جراحة (Vitrectomy/Scleral Buckle)

التأثيرات المصاحبة لـ ROP المتأخر:
- ندبة بقعية
- حول (Strabismus)
- ضعف بصر شديد
- ضعف في المجال المحيطي
- قِصَر النظر المفرط (High Myopia)

بروتوكول التأهيل:
1. تقييم شامل ≥ 6 أشهر
2. النظارات لمعالجة الانكسار المرتبط
3. أجهزة مساعدة مناسبة للعمر:
   - 0-3 سنوات: ألعاب بصرية عالية التباين
   - 3-6 سنوات: تمارين إدراك بصري
   - 6+: أجهزة CCTV للمدرسة
4. تدخل مبكر متعدد التخصصات مع:
   - طب الأطفال
   - العلاج الوظيفي
   - التربية الخاصة
""",
        "tags": ["ROP", "خدج", "شبكية", "أطفال", "ولادة مبكرة", "LMA"]
    },

    # ─── التأهيل العصبي البصري ───
    {
        "id": "neuro_visual_rehab",
        "category": "treatment_plans",
        "title": "التأهيل العصبي البصري (Neuro-Visual Rehabilitation)",
        "text": """
التأهيل العصبي البصري:

الحالات الشائعة:
- السكتة الدماغية (Stroke) مع Hemianopia
- إصابات الرأس (TBI) مع اضطرابات بصرية
- التصلب اللويحي المتعدد (MS) مع التهاب عصب بصري
- الأورام الدماغية بعد العلاج
- ضعف البصر العصبي (Optic Neuropathy)

المشاكل البصرية العصبية الشائعة:
1. فقدان نصف المجال البصري (Hemianopia):
   - Homonymous: فقدان نفس النصف في كلتا العينين
   - Bitemporal: نادر، من ورم نخامي

2. اضطرابات حركة العين:
   - شلل العصب الثالث: تدلي الجفن + توسع الحدقة
   - شلل العصب السادس: حول أفقي + رؤية مزدوجة
   - Nystagmus: تأرجح غير إرادي

3. صعوبات الإدراك البصري:
   - Alexia (عمى الكلمات)
   - Visual agnosia (عدم التعرف البصري)
   - Neglect (إهمال نصف الفضاء)

بروتوكولات التدخل:
1. للـ Hemianopia:
   - تدريب Scanning منهجي للجانب المفقود
   - Prism glasses للتوسيع المؤقت
   - تمارين Saccadic Eye Movements

2. للـ Diplopia (رؤية مزدوجة):
   - تغطية عين مؤقتاً (Patching)
   - Prism للعلاج
   - علاج السبب الجذري

3. للـ Nystagmus:
   - إيجاد Null Point (أفضل موضع للرأس)
   - عدسات للتقليل من الحركة
   - Prism في بعض الحالات

معايير التحسن:
- توسع المجال البصري الفعّال
- تقليل حوادث التصادم والسقوط
- تحسين سرعة القراءة واستيعاب النص
- نتائج VFQ-25 قسم الوظيفة البصرية
""",
        "tags": ["عصبي", "سكتة دماغية", "TBI", "hemianopia", "نيورولوجي", "بصري"]
    },

    # ─── التوجه والتنقل ───
    {
        "id": "orientation_mobility_protocol",
        "category": "protocols",
        "title": "بروتوكول التوجه والتنقل (O&M Protocol)",
        "text": """
التوجه والتنقل (Orientation & Mobility - O&M):

التعريف:
- التوجه: معرفة موضعك في البيئة
- التنقل: القدرة على التحرك بأمان وفعالية

المهارات الأساسية:
1. التوجه الحسي:
   - استخدام السمع للتعرف على البيئة
   - استخدام اللمس والحركة
   - الخرائط الذهنية للبيئات المألوفة

2. تقنيات العصا البيضاء:
   - Touch Technique (اللمس المتناوب)
   - Constant Contact Technique
   - Diagonal Technique (في الداخل)
   - Two-Point Touch Technique

3. تقنيات الإرشاد البشري:
   - Modified Sighted Guide Technique
   - الدخول للأماكن الضيقة
   - الدرج والأسطح المتغيرة

4. مهارات التنقل في الخارج:
   - تقاطعات الطرق البسيطة والمعقدة
   - استخدام وسائل النقل العام
   - التنقل في الأماكن غير المألوفة

مراحل البرنامج التدريبي:
- المرحلة 1 (2-4 أسابيع): داخل المنزل والمبنى
- المرحلة 2 (4-6 أسابيع): حي سكني مألوف
- المرحلة 3 (6-8 أسابيع): تقاطعات وأماكن عامة
- المرحلة 4 (8-12 أسبوع): مواصلات عامة وبيئات جديدة

التقنيات الحديثة المساعدة:
- تطبيقات الملاحة الصوتية (Google Maps وضع الرؤية المنخفضة)
- OrCam للقراءة اللحظية
- Sonar Electronic Travel Aids
- GPS متخصص لضعاف البصر

الكلاب المرشدة:
- معيار: ضعف بصر شديد + لياقة جسدية
- التدريب: 3-4 أسابيع
- متابعة مدى الحياة

معايير التقييم:
- Hill Performance Test of Selected Positional Concepts
- Blindness Learning Reading Test (BLRT)
- Independent Living Scale
""",
        "tags": ["O&M", "توجه", "تنقل", "عصا بيضاء", "استقلالية", "كلاب مرشدة"]
    },

    # ─── القراءة العربية وضعف البصر ───
    {
        "id": "arabic_reading_low_vision",
        "category": "protocols",
        "title": "بروتوكول القراءة العربية لضعف البصر",
        "text": """
بروتوكول القراءة العربية لمرضى ضعف البصر:

خصائص الخط العربي التي تؤثر على القراءة بضعف البصر:
1. الكتابة من اليمين إلى اليسار (RTL)
2. التشكيل (Diacritical Marks): يزيد الصعوبة 25-30%
3. الحروف المتصلة: تتطلب دقة أعلى من الحروف المنفصلة
4. نقاط الحروف: (ب/ت/ث/ج/ح) تتشابه بضعف التباين

حسابات حجم الطباعة:
- نص عادي: تكبير × 2 من الحد الأدنى للقراءة
- نص مشكّل: تكبير × 1.3 إضافي
- القرآن الكريم: حد أدنى 18pt مع تشكيل كامل
- كتب الأطفال: 18-24pt

معيار MNREAD-A للعربية:
- قراءة وظيفية: ≥ 60 كلمة/دقيقة
- قراءة سليمة: ≥ 120 كلمة/دقيقة
- العتبة للمكبر: حين يقل عن 60 كلمة/دقيقة بدون مساعدة

بروتوكول تدريب القراءة العربية:
المرحلة 1 — تقييم الخط الأساسي:
  - MNREAD-A: سرعة القراءة وحدة حدة الإبصار ومسافة القراءة
  - نصوص بدون وبمع تشكيل
  - اختبار القراءة القرآنية خصيصاً إذا كانت هدف المريض

المرحلة 2 — اختيار الجهاز المناسب:
  - مكبر يدوي للاستخدام القصير
  - CCTV للقراءة المطولة
  - iPad/Tablet للنص الرقمي مع تطبيقات القرآن

المرحلة 3 — التدريب:
  - تمارين RTL Scanning مع المكبر
  - تقنية Typoscope بالعربية
  - استراحة 5-10 دقيقة كل 20 دقيقة قراءة

خاصية الأنظمة الإلكترونية للعربية:
- الخطوط المناسبة: Simplified Arabic, Traditional Arabic
- تجنب: أمبري أو الخطوط الزخرفية بضعف البصر
- الحد الأدنى للحجم الرقمي: 18-20pt
""",
        "tags": ["عربي", "قراءة", "MNREAD-A", "تشكيل", "قرآن", "RTL", "خط"]
    },

    # ─── التكيف النفسي مع فقدان البصر ───
    {
        "id": "psychological_adjustment_vision_loss",
        "category": "protocols",
        "title": "بروتوكول التكيف النفسي مع فقدان البصر",
        "text": """
التكيف النفسي مع فقدان البصر:

الأثر النفسي لفقدان البصر:
- خطر الاكتئاب: 3-5 أضعاف مقارنة بالسكان العاديين
- خطر القلق: 2-3 أضعاف
- العزلة الاجتماعية شائعة خاصةً لكبار السن
- فقدان الهوية المهنية والاجتماعية

مراحل التكيف (كوبلر-روس المعدّلة لفقدان البصر):
1. الإنكار: رفض قبول التشخيص، البحث عن آراء ثانية
2. الغضب: نحو العائلة أو الطبيب أو القدر
3. المساومة: البحث عن علاجات بديلة، الأمل الزائد
4. الاكتئاب: حزن عميق، انسحاب، فقدان الاهتمام
5. القبول: التكيف الإيجابي، إيجاد معنى جديد

أدوات الفحص المعتمدة:
- PHQ-2: فحص أولي سريع (سؤالان)
- PHQ-9: تقييم الاكتئاب الكامل (9 أسئلة)
- GDS-15: مقياس الاكتئاب للمسنين (15 سؤالاً)
- VFQ-25 القسم النفسي: جودة الحياة البصرية

التدخلات النفسية الفعّالة:
1. العلاج السلوكي المعرفي المعدّل لضعف البصر (CBT-VI):
   - تعديل الأفكار السلبية عن فقدان البصر
   - التعرض التدريجي للمواقف المتجنَّبة
   - تنشيط السلوك الإيجابي

2. العلاج بالقبول والالتزام (ACT):
   - قبول الواقع البصري
   - التركيز على القيم والأهداف بديلاً عن الفقد
   - Mindfulness للتعامل مع الإجهاد

3. مجموعات الدعم:
   - دعم الأقران من مرضى ضعف البصر
   - مشاركة التجارب والحلول العملية
   - تقليل الشعور بالوحدة

4. الدعم الأسري:
   - تثقيف العائلة عن الاحتياجات والقدرات
   - تحقيق التوازن بين المساعدة والاستقلالية
   - تجنب الحماية الزائدة

مؤشرات الإحالة للطب النفسي:
- PHQ-9 ≥ 15
- أفكار انتحارية (Q9 أي درجة > 0)
- اكتئاب لا يستجيب لـ 4 أسابيع دعم
- قصور وظيفي شديد
""",
        "tags": ["نفسي", "اكتئاب", "PHQ-9", "تكيف", "فقدان البصر", "CBT", "دعم"]
    },

    # ─── اعتلال الشبكية الصباغي ───
    {
        "id": "retinitis_pigmentosa_rehab",
        "category": "treatment_plans",
        "title": "تأهيل اعتلال الشبكية الصباغي (RP)",
        "text": """
بروتوكول تأهيل اعتلال الشبكية الصباغي (Retinitis Pigmentosa - RP):

الخصائص المميزة:
- فقدان الرؤية الليلية أولاً (Night Blindness)
- تضيق تدريجي في المجال البصري
- قد تبقى حدة الإبصار المركزية طويلاً
- وراثي: أكثر أنواع ضعف البصر الوراثية شيوعاً

التسلسل الطبيعي:
- مرحلة مبكرة: عمى ليلي + ضعف مجال محيطي
- مرحلة متوسطة: Tunnel Vision (رؤية نفقية)
- مرحلة متأخرة: فقدان المركز + عمى وظيفي

التقييم الخاص بـ RP:
- Goldmann Perimetry: لرسم المجال البصري المتبقي
- ERG (Electroretinogram): لقياس وظيفة الشبكية
- Dark Adaptation Testing: لقياس التكيف الليلي
- OCT: لمتابعة السُّمك البقعي

التدخلات:
1. للرؤية الليلية:
   - نظارات Night Driving بعدسة منقرة الوهج
   - أجهزة التصوير الحراري (NVG) في الحالات الشديدة
   - تحسين الإضاءة الداخلية بشكل ملحوظ

2. لفقدان المجال المحيطي:
   - عدسات Prism للتوسيع البصري
   - تدريب O&M مبكر (قبل التدهور الشديد)
   - تقنيات Scanning المنهجي

3. للمرحلة المتقدمة:
   - التخطيط المسبق: "Planning for Blindness"
   - تعلم البرايل أو النصوص الصوتية بشكل استباقي
   - إدارة قانونية ومالية مبكرة

الدعم النفسي الخاص بـ RP:
- التعامل مع التدهور التدريجي المتوقع
- خطط مستقبلية واقعية دون يأس
- مجموعات دعم عائلات RP

التطورات العلاجية:
- حقن مضادات الأكسدة (Vitamin A Palmitate - جدل علمي)
- Gene Therapy: موجودة لبعض الجينات (RPE65)
- Retinal Prosthesis (Argus II): للمرحلة النهائية
""",
        "tags": ["RP", "شبكية صباغي", "عمى ليلي", "مجال بصري", "وراثي", "تأهيل"]
    },

    # ─── ساد (إعتام عدسة العين) ───
    {
        "id": "cataract_pre_post_op",
        "category": "protocols",
        "title": "بروتوكول ما قبل وبعد جراحة الساد (إعتام عدسة العين)",
        "text": """
بروتوكول الساد — قبل وبعد الجراحة:

قبل الجراحة:
1. التقييم الوظيفي:
   - هل يؤثر الساد فعلاً على الوظائف اليومية؟
   - مقارنة حدة الإبصار مع وبدون تصحيح
   - Visual Glare Testing (Brightness Acuity Tester)

2. تعديلات مؤقتة:
   - زيادة الإضاءة في بيئة المريض
   - نظارات تصفية الوهج (Anti-glare tints)
   - نظارات قراءة بحجم مناسب للمرحلة الحالية

بعد الجراحة — المرحلة المبكرة (0-4 أسابيع):
- تعليمات قطرات العين وجدولها
- تجنب: الضغط على العين، الإجهاد، الماء
- استئناف القراءة: عادةً بعد 3-7 أيام
- قياس الانكسار الجديد: بعد 4-6 أسابيع

بعد الجراحة — التأهيل:
1. تعديل العدسات الجديدة (IOL):
   - Monofocal: نظارات للقراءة ضرورية
   - Multifocal: تكيف بصري قد يستغرق 3-6 أشهر
   - Toric: لتصحيح الاستجماتيزم

2. حالات Residual Low Vision:
   - إذا كان الساد يُصاحب ضمور بقعي أو تلف شبكية
   - التقييم البصري الوظيفي الكامل بعد 6-8 أسابيع
   - بدء برنامج التأهيل البصري الكامل

3. ما بعد الساد الثانوي (PCO):
   - Nd:YAG Laser Capsulotomy
   - التأهيل البصري بعد التدخل

مؤشرات عدم التحسن بعد الجراحة:
- وجود ضمور بقعي (AMD)
- اعتلال الشبكية السكري
- غيوم القرنية (Corneal Opacity)
- أمراض العصب البصري
→ في هذه الحالات: إحالة لبرنامج تأهيل بصري متخصص
""",
        "tags": ["ساد", "إعتام عدسة", "جراحة", "ما بعد عملية", "IOL", "تأهيل"]
    },

    # ─── الأطفال ذوو الإعاقة البصرية والمدرسة ───
    {
        "id": "school_visual_impairment_protocol",
        "category": "protocols",
        "title": "بروتوكول الطالب ذو الإعاقة البصرية في المدرسة",
        "text": """
بروتوكول الطالب ذو الإعاقة البصرية في المدرسة:

التشريع والحقوق:
- الطلاب ذوو الإعاقة البصرية لهم حق في التعليم المتكافئ
- وثيقة IEP (Individual Education Program) إلزامية
- تعديلات المنهج والبيئة من حقوق المريض

التقييم التعليمي:
1. Functional Vision Assessment (FVA) في بيئة المدرسة
2. Learning Media Assessment: هل البرايل أم المطبوع مناسب؟
3. تقييم مدى الأثر على المواد الدراسية المختلفة

تعديلات الفصل الدراسي:
البيئة الجسدية:
- الجلوس في الصف الأول (مسافة ≤ 2م من السبورة)
- إضاءة كافية وبلا ظلال على المقاعد
- السبورة بيضاء (Whiteboard) بمؤشر عريض ومتباين

المواد التعليمية:
- تكبير المواد المطبوعة (ملحوظة: تكبير ≥ 24pt)
- نسخ رقمية للكتب للتكبير في الكمبيوتر
- الوقت الإضافي للاختبارات (50-100%)

التقنيات المساعدة في المدرسة:
- مكبر CCTV للمطبوعات
- كمبيوتر مع برامج تكبير (ZoomText/Windows Magnifier)
- Screen Reader لضعف البصر الشديد
- الآلة الحاسبة الناطقة

مهارات الحياة المستقلة (ILS):
- التنقل في المدرسة بأمان
- استخدام المرافق والكافيتيريا
- تدريب على المهارات الاجتماعية

دور الأخصائي في المدرسة:
- التواصل مع المعلمين والإدارة
- تدريب الكادر التعليمي
- تدريب الطالب على أجهزته
- تقرير منتصف الفصل ونهايته

الانتقال من المدرسة للجامعة:
- التخطيط المبكر من سنوات دراسية مبكرة
- التواصل مع مراكز ذوي الاحتياجات الخاصة في الجامعة
- مهارات المناصرة الذاتية (Self-Advocacy)
""",
        "tags": ["مدرسة", "تعليم", "IEP", "طالب", "أطفال", "بصري", "تكيف"]
    },

    # ─── الشيخوخة وضعف البصر ───
    {
        "id": "elderly_low_vision_rehab",
        "category": "treatment_plans",
        "title": "تأهيل ضعف البصر لكبار السن",
        "text": """
خصائص ضعف البصر لدى كبار السن:

التغيرات البصرية الطبيعية مع التقدم في العمر:
- Presbyopia: فقدان التركيز القريب (طبيعي من 40+)
- تقليل التكيف في الإضاءة المنخفضة
- زيادة الحساسية للوهج
- تراجع حساسية التباين

الأسباب الأكثر شيوعاً لضعف البصر في كبار السن:
- الضمور البقعي المرتبط بالعمر (AMD): الأكثر شيوعاً
- الساد (Cataract): قابل للعلاج جراحياً
- الجلوكوما (Glaucoma): ثاني أكثر مسبب للعمى
- الاعتلال السكري (Diabetic Retinopathy)

خصوصيات تأهيل كبار السن:
1. التكيف الأبطأ مع الأجهزة الجديدة (2-4 أضعاف وقت الشباب)
2. اشتراط سهولة الاستخدام (User-Friendly Devices)
3. التأثير على الكرامة الشخصية والاستقلالية أهم من الأداء التقني
4. الأمراض المصاحبة تؤثر: السرطان، رعاش اليد، الخرف

مخاطر خاصة:
- السقوط: ضعف البصر يزيد خطر السقوط 2-4 أضعاف
  → تقييم Safety الشامل في المنزل
- العزلة الاجتماعية: قد يتوقف عن الخروج
  → ربط بخدمات المجتمع والمواصلات
- الاكتئاب: GDS-15 مناسب للتقييم

الأجهزة الأكثر نجاحاً مع كبار السن:
- مكبر يدوي بضوء LED (سهل + مألوف)
- هاتف ذكي بالتكبير (أي Accessibility Settings)
- CCTV للقراءة المطولة
- مكبر مستقل بأضواء (Stand Magnifier مضاء)

اعتبارات خاصة بالسعودية:
- التجمع الأسري يوفر دعماً طبيعياً
- القرآن الكريم هدف قراءة رئيسي لكبار السن
- الأنشطة الدينية (الصلاة، الحج) أولوية وظيفية
""",
        "tags": ["كبار السن", "شيخوخة", "AMD", "سقوط", "استقلالية", "تأهيل"]
    },
]


# ═══════════════════════════════════════════════════════════════
# محرك البحث (BM25-like TF-IDF)
# ═══════════════════════════════════════════════════════════════

def _tokenize(text: str) -> list:
    """تحليل النص إلى كلمات"""
    text = text.lower()
    # إزالة علامات الترقيم
    text = re.sub(r'[^\w\s\u0600-\u06FF]', ' ', text)
    return [w for w in text.split() if len(w) > 1]


def _compute_tf_idf_score(query_tokens: list, doc: dict) -> float:
    """حساب درجة التطابق بين الاستعلام والوثيقة"""
    doc_text = (doc.get("text", "") + " " + doc.get("title", "") + " " + " ".join(doc.get("tags", []))).lower()
    doc_tokens = _tokenize(doc_text)

    if not doc_tokens:
        return 0.0

    # TF: تكرار كل كلمة في الوثيقة
    score = 0.0
    for token in query_tokens:
        tf = doc_tokens.count(token) / len(doc_tokens)
        # زيادة وزن الكلمات في العنوان والتاجز
        title_boost = 3.0 if token in doc.get("title", "").lower() else 1.0
        tag_boost = 2.0 if any(token in tag.lower() for tag in doc.get("tags", [])) else 1.0
        score += tf * title_boost * tag_boost

    return score


def search_vector_db(params: dict) -> dict:
    """
    البحث في القاعدة المعرفية المحلية

    Args:
        params: {
            query (str): الاستعلام
            category (str): تصفية حسب الفئة (اختياري)
            top_k (int): عدد النتائج (افتراضي: 5)
        }
    """
    query = params.get("query", "")
    category = params.get("category")
    top_k = params.get("top_k", 5)

    if not query:
        return {"error": "يجب تحديد استعلام البحث"}

    # تصفية حسب الفئة
    docs = KNOWLEDGE_BASE
    if category:
        docs = [d for d in docs if d.get("category") == category]

    if not docs:
        return {
            "results": [],
            "message": f"لا توجد وثائق في الفئة: {category}"
        }

    # تحليل الاستعلام
    query_tokens = _tokenize(query)

    # حساب الدرجات
    scored_docs = []
    for doc in docs:
        score = _compute_tf_idf_score(query_tokens, doc)
        if score > 0:
            scored_docs.append((score, doc))

    # ترتيب حسب الصلة
    scored_docs.sort(key=lambda x: x[0], reverse=True)

    # إعداد النتائج
    results = []
    for score, doc in scored_docs[:top_k]:
        results.append({
            "title": doc.get("title", ""),
            "category": doc.get("category", ""),
            "text": doc.get("text", "").strip(),
            "tags": doc.get("tags", []),
            "relevance_score": round(score, 4),
            "source": f"قاعدة المعرفة المحلية — {doc.get('id', '')}"
        })

    if not results:
        return {
            "results": [],
            "query": query,
            "message": "لم يتم العثور على نتائج ذات صلة. جرب مصطلحات مختلفة."
        }

    return {
        "results": results,
        "total_found": len(results),
        "query": query,
        "category_filter": category or "الكل"
    }


def add_document_to_kb(doc: dict) -> bool:
    """
    إضافة وثيقة جديدة للقاعدة المعرفية

    Args:
        doc: {
            "id": str,
            "category": str,
            "title": str,
            "text": str,
            "tags": list
        }
    """
    required = ["id", "category", "title", "text"]
    for field in required:
        if field not in doc:
            return False

    KNOWLEDGE_BASE.append(doc)
    return True
